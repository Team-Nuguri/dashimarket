<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.mypage.dao.MyPageMapper">
	
	<resultMap type="Joonggo" id="joonggo_rm">
   
      <id property="joonggoNo" column="BOARD_NO"/>
      
      <result property="joonggoTitle" column="BOARD_TITLE"/>
      <result property="joonggoContent" column="BOARD_CONTENT"/>
      <result property="joonggoCreateDate" column="BOARD_CREATE_DATE"/>
      <result property="joonggoUpdateDate" column="BOARD_UPDATE_DATE"/>
      <result property="readCount" column="POST_VIEWS"/>
      <result property="likeCount" column="LIKE_COUNT"/>
      <result property="joonggoPrice" column="JOONGGO_PRICE" />
      <result property="thumbnail" column="THUMBNAIL" />
      
      
      <!--회원 -->
      <result property="memberNickname" column="MEMBER_NICKNAME"/>
      <result property="memberNo" column="MEMBER_NO"/>
      <result property="profileImage" column="PROFILE_PATH"/>
      <result property="defaultDong" column="DEFAULT_DONG"/>
      <result property="sellerRating" column="SELLER_RATING"/>
      
      <!--카테고리-->
      <result property="categoryId" column="CATEGORY_ID"/>
      <result property="parentCategoryNo" column="PARENT_CATEGORY_NO"/>
      <result property="mainCategory" column="MAIN"/>
      <result property="subCategory" column="SUB"/>
      
            
      <result property="boardCode" column="BOARD_CODE"/>
      <result property="boardType" column="BOARD_TYPE"/>
      
       
        
       
      
      
      <!-- collection 태그  
		- select로 조회된 결과를 컬렉션(List)에 담아 지정된 필드에 세팅
        - property : list에 담을 DTO 필드명
        - select : 실행할 select의 id 	 
        - column : 조회 결과 중 지정된 컬럼의 값을 파라미터로 전달
        - javaType : List(컬렉션)의 타입 지정 
        - ofType : List(컬레션)의 제네릭 지정
      -->
      <collection property="imageList" select="selectImageList" 
      			  column="BOARD_NO" javaType="java.util.ArrayList"  
      			  ofType="Image" 
      			  >     
      </collection>
      
      
   </resultMap>
   
    <!--이미지 rm-->
   <resultMap id="image_rm" type="Image">
	   
	  <id property="imageNo" column="IMG_NO"/>
      
      <result property="imagePath" column="IMG_PATH"/>
      <result property="imageRename" column="IMG_RENAME"/>
      <result property="imageOrder" column="IMG_ORDER"/>
      <result property="boardNo" column="BOARD_NO"/>   
   </resultMap>

    <!-- 회원 정보 조회 (비밀번호 제외) -->
    <select id="selectMember" parameterType="int" resultType="Member">
        SELECT 
            MEMBER_NO as memberNo,
            MEMBER_EMAIL as memberEmail,
            MEMBER_NAME as memberName,
            MEMBER_NICKNAME as memberNickname,
            MEMBER_TEL as memberTel,
            POST_CODE as postCode,
            LOAD_ADDRESS as loadAddress,
            DETAIL_ADDRESS as detailAddress,
            DEFAULT_DONG as defaultDong,
            PROFILE_PATH as profilePath,
            TO_CHAR(ENROLL_DATE, 'YYYY"년" MM"월" DD"일"') AS enrollDate,
            SECESSIONFL as secessionFl,
            IS_ADMIN as isAdmin,
            JIBUN_ADDRESS as jibunAddress
            
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
          AND SECESSIONFL = 'N'
    </select>

    <!-- 회원 정보 조회 (비밀번호 포함) -->
    <select id="selectMemberWithPassword" parameterType="int" resultType="Member">
        SELECT 
            MEMBER_NO as memberNo,
            MEMBER_EMAIL as memberEmail,
            MEMBER_PW as memberPw,
            MEMBER_NAME as memberName,
            MEMBER_NICKNAME as memberNickname,
            MEMBER_TEL as memberTel
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
          AND SECESSIONFL = 'N'
    </select>

    <!-- 프로필 정보 업데이트 (이거 하나만 있어야 함!) -->
    <update id="updateProfile" parameterType="Member">
        UPDATE MEMBER
        SET
            MEMBER_NICKNAME = #{memberNickname},
            MEMBER_TEL = #{memberTel},
            POST_CODE = #{postCode},
            LOAD_ADDRESS = #{loadAddress},
            DETAIL_ADDRESS = #{detailAddress},
            DEFAULT_DONG = #{defaultDong},
            PROFILE_PATH = #{profilePath}
            <if test="memberPw != null and memberPw != ''">
            , MEMBER_PW = #{memberPw}
            </if>
        WHERE MEMBER_NO = #{memberNo}
    </update>
    
    <!-- 회원 탈퇴 -->
	<update id="secession" parameterType="_int">
		UPDATE MEMBER SET
		SECESSIONFL = 'Y'
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 암호화된 비밀번호 조회 (회원 탈퇴 시 비밀번호 확인용) -->
	<select id="selectEncPw" parameterType="int" resultType="String">
    SELECT MEMBER_PW
    FROM MEMBER
    WHERE MEMBER_NO = #{memberNo}
    AND SECESSIONFL = 'N'
	</select>
	
	<!-- 굿즈 거래내역 목록 조회 -->
	<select id="selectGoods" parameterType="int" resultType="map">
		SELECT
		    oi.ORDER_ITEM_ID AS orderItemNo,
		    o.ORDER_NO AS orderNo,
		    s.RECIPIENT_NAME AS recipientName,
		    s.RECIPIENT_TEL AS recipientTel,
		    s.POSTCODE AS postcode,
		    s.ADDRESS_BASE AS addressBase,
		    s.ADDRESS_DETAIL AS addressDetail,
		    s.TRACKING_NUMBER AS trackingNumber,
		    s.DELIVERY_STATUS AS 구매상태,
		    b.BOARD_TITLE AS 제품명,
		    oi.UNIT_PRICE AS 단가,
		    oi.ORDER_QUANTITY AS 수량,
		    (oi.UNIT_PRICE * oi.ORDER_QUANTITY) AS 총가격,
		    p.PAT_DATE AS 결제날짜,
		    p.PAY_METHOD AS payMethod,
		    p.PRICE AS price
		FROM ORDER_ITEM oi
		INNER JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
		LEFT JOIN SHIPPING s ON o.ORDER_NO = s.ORDER_NO
		LEFT JOIN PAYMENT p ON o.ORDER_NO = p.ORDER_NO
		LEFT JOIN BOARD b ON oi.ORDER_ITEM_NO = b.BOARD_NO
		WHERE o.MEMBER_NO = #{memberNo}
		
		<if test="keyword != null and keyword != ''">
			AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
		</if>
		
		ORDER BY p.PAT_DATE DESC

	</select>
	
	<!-- 굿즈 거래 전체 개수 조회 (추가!) -->
		<select id="getGoodsListCount" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM ORDER_ITEM oi
		INNER JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
		LEFT JOIN BOARD b ON oi.ORDER_ITEM_NO = b.BOARD_NO
		WHERE o.MEMBER_NO = #{memberNo}
		<if test="keyword != null and keyword != ''">
		    AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
</if>
</select>
	
<!-- 굿즈 거래내역 목록 조회 (페이지네이션 - RowBounds) -->
<select id="selectGoodsList" parameterType="map" resultType="map">
SELECT
    oi.ORDER_ITEM_NO AS orderItemNo,
    o.ORDER_NO AS orderNo,
    o.MEMBER_NO AS memberNo,
    s.RECIPIENT_NAME AS recipientName,
    s.RECIPIENT_TEL AS recipientTel,
    s.POSTCODE AS postcode,
    s.ADDRESS_BASE AS addressBase,
    s.ADDRESS_DETAIL AS addressDetail,
    s.TRACKING_NUMBER AS trackingNumber,
    s.DELIVERY_STATUS AS 구매상태,
    b.BOARD_TITLE AS 제품명,
    oi.UNIT_PRICE AS 단가,
    oi.ORDER_QUANTITY AS 수량,
    (oi.UNIT_PRICE * oi.ORDER_QUANTITY) AS 총가격,
    p.PAT_DATE AS 결제날짜,
    p.PAY_METHOD AS payMethod,
    p.PRICE AS price,
    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		        WHERE I.BOARD_NO = b.BOARD_NO
		        AND IMG_ORDER = 0)AS imagePath
FROM ORDER_ITEM oi
INNER JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
LEFT JOIN SHIPPING s ON o.ORDER_NO = s.ORDER_NO
LEFT JOIN PAYMENT p ON o.ORDER_NO = p.ORDER_NO
LEFT JOIN BOARD b ON oi.ORDER_ITEM_NO = b.BOARD_NO
WHERE o.MEMBER_NO = #{memberNo}
<if test="keyword != null and keyword != ''">
    AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
</if>
ORDER BY p.PAT_DATE DESC
</select>

<!-- 구매 확정 -->
<update id="confirmPurchase" parameterType="map">
    UPDATE SHIPPING
    SET DELIVERY_STATUS = '구매확정'
    WHERE ORDER_NO = (
        SELECT o.ORDER_NO
        FROM ORDER_ITEM oi
        JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
        WHERE oi.ORDER_NO = ${orderItemNo}
          AND o.MEMBER_NO = #{memberNo}
    )
</update>


<!-- 중고 거래 전체 개수 조회 (getOrderListCount) -->
<select id="getOrderListCount" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM TRADE t 
    INNER JOIN BOARD b ON t.BOARD_NO = b.BOARD_NO
    WHERE 1=1
    <choose>
        <when test="tradeType == 'buy'">
            AND t.MEMBER_NO2 = #{memberNo}
        </when>
        <when test="tradeType == 'sell'">
            AND t.MEMBER_NO = #{memberNo}
        </when>
    </choose>
    <if test="keyword != null and keyword != ''">
        AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
    </if>
</select>


<!-- 중고 거래내역 목록 조회 (페이지네이션 - RowBounds) -->
<select id="selectOrderList" parameterType="map" resultType="map">
SELECT
    t.BOARD_NO AS productNo,
    t.TRADE_DATE AS tradeDate,
    t.MEMBER_NO2 AS buyerNo,
    t.MEMBER_NO AS sellerNo,
    b.BOARD_TITLE AS productName,
    NVL(t.REVIEW_FL, 'N') AS reviewFl,
    seller.MEMBER_NICKNAME AS sellerName,
    buyer.MEMBER_NICKNAME AS buyerName,
    (
        SELECT sub.IMG_PATH || sub.IMG_RENAME
        FROM (
            SELECT IMG_PATH, IMG_RENAME
            FROM IMAGE img
            WHERE img.BOARD_NO = t.BOARD_NO
            ORDER BY img.IMG_ORDER
        ) sub
        WHERE ROWNUM = 1
    ) AS productImagePath
FROM TRADE t
JOIN BOARD b ON t.BOARD_NO = b.BOARD_NO
JOIN MEMBER seller ON t.MEMBER_NO = seller.MEMBER_NO
JOIN MEMBER buyer ON t.MEMBER_NO2 = buyer.MEMBER_NO
WHERE 1=1
<choose>
    <when test="tradeType == 'buy'">
    AND t.MEMBER_NO2 = #{memberNo}
    </when>
    <when test="tradeType == 'sell'">
    AND t.MEMBER_NO = #{memberNo}
    </when>
</choose>
<if test="keyword != null and keyword != ''">
    AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
</if>
ORDER BY t.TRADE_DATE DESC
</select>



   <!-- 중고상품 위시리스트 목록 조회 (KJK) -->
	<select id="selectJoonggoWishList" resultMap="joonggo_rm">
		SELECT B.BOARD_NO, BOARD_TITLE,  JOONGGO_PRICE,
		  (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		FROM "BOARD" B
		JOIN "JOONGGO" J ON(J.BOARD_NO = B.BOARD_NO)
		JOIN "LIKE" L ON(L.POST_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_CODE = 1
		AND L.MEMBER_NO = ${memberNo}
		ORDER BY BOARD_CREATE_DATE DESC
	</select>
	
	<!-- 중고상품 위시리스트 목록 삭제 (KJK) -->
	<delete id="deleteJoonggoWishList">
		DELETE FROM "LIKE"
		WHERE POST_NO = #{param2}
		AND MEMBER_NO = #{param1}
	</delete>
	
	<!-- 중고상품 위시리스트 목록 조회관련 (KJK) -->
	<select id="selectImageList" resultMap ="image_rm">
		SELECT * FROM IMAGE
		WHERE BOARD_NO = #{boardNo}
		ORDER BY IMG_ORDER	
	</select>
	
</mapper>
