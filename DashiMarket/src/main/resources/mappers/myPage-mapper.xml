<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.mypage.dao.MyPageMapper">

    <!-- 회원 정보 조회 (비밀번호 제외) -->
    <select id="selectMember" parameterType="int" resultType="Member">
        SELECT 
            MEMBER_NO as memberNo,
            MEMBER_EMAIL as memberEmail,
            MEMBER_NAME as memberName,
            MEMBER_NICKNAME as memberNickname,
            MEMBER_TEL as memberTel,
            POST_CODE as postCode,
            LOAD_ADDRESS as loadAddress,
            DETAIL_ADDRESS as detailAddress,
            DEFAULT_DONG as defaultDong,
            PROFILE_PATH as profilePath,
            TO_CHAR(ENROLL_DATE, 'YYYY"년" MM"월" DD"일"') AS enrollDate,
            SECESSIONFL as secessionFl,
            IS_ADMIN as isAdmin,
            JIBUN_ADDRESS as jibunAddress
            
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
          AND SECESSIONFL = 'N'
    </select>

    <!-- 회원 정보 조회 (비밀번호 포함) -->
    <select id="selectMemberWithPassword" parameterType="int" resultType="Member">
        SELECT 
            MEMBER_NO as memberNo,
            MEMBER_EMAIL as memberEmail,
            MEMBER_PW as memberPw,
            MEMBER_NAME as memberName,
            MEMBER_NICKNAME as memberNickname,
            MEMBER_TEL as memberTel
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
          AND SECESSIONFL = 'N'
    </select>

    <!-- 프로필 정보 업데이트 (이거 하나만 있어야 함!) -->
    <update id="updateProfile" parameterType="Member">
        UPDATE MEMBER
        SET
            MEMBER_NICKNAME = #{memberNickname},
            MEMBER_TEL = #{memberTel},
            POST_CODE = #{postCode},
            LOAD_ADDRESS = #{loadAddress},
            DETAIL_ADDRESS = #{detailAddress},
            DEFAULT_DONG = #{defaultDong},
            PROFILE_PATH = #{profilePath}
            <if test="memberPw != null and memberPw != ''">
            , MEMBER_PW = #{memberPw}
            </if>
        WHERE MEMBER_NO = #{memberNo}
    </update>
    
    <!-- 회원 탈퇴 -->
	<update id="secession" parameterType="_int">
		UPDATE MEMBER SET
		SECESSIONFL = 'Y'
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 암호화된 비밀번호 조회 (회원 탈퇴 시 비밀번호 확인용) -->
	<select id="selectEncPw" parameterType="int" resultType="String">
    SELECT MEMBER_PW
    FROM MEMBER
    WHERE MEMBER_NO = #{memberNo}
    AND SECESSIONFL = 'N'
	</select>
	
	<select id="selectGoods" parameterType="String" resultType="map">
	    
	    SELECT 
	        G.GOODS_TITLE AS 제품명,
	        G.GOODS_PRICE AS 단가,
	        OI.ORDER_QUANTITY AS 수량,
	        (G.GOODS_PRICE * OI.ORDER_QUANTITY) AS 총가격,
	        P.PAY_DATE AS 결제날짜,
	        OS.STATUS_NAME AS 구매상태  -- O.ORDER_STATUS 대신 JOIN된 OS.STATUS_NAME 사용
	    FROM 
	        ORDERS O
	    JOIN 
	        ORDER_ITEM OI ON O.ORDER_ID = OI.ORDER_ID
	    JOIN 
	        GOODS G ON OI.GOODS_ID = G.GOODS_ID
	    JOIN 
	        PAYMENT P ON O.ORDER_ID = P.ORDER_ID
	    JOIN 
	        ORDER_STATUS OS ON O.STATUS_CODE = OS.STATUS_CODE
	    WHERE 
	        O.MEMBER_ID = #{memberEmail} 
	    ORDER BY 
	        O.ORDER_DATE DESC
	        
	</select>
	
</mapper>