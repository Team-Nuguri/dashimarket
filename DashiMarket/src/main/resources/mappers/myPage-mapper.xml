<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.mypage.dao.MyPageMapper">

    <!-- 회원 정보 조회 (비밀번호 제외) -->
    <select id="selectMember" parameterType="int" resultType="Member">
        SELECT 
            MEMBER_NO as memberNo,
            MEMBER_EMAIL as memberEmail,
            MEMBER_NAME as memberName,
            MEMBER_NICKNAME as memberNickname,
            MEMBER_TEL as memberTel,
            POST_CODE as postCode,
            LOAD_ADDRESS as loadAddress,
            DETAIL_ADDRESS as detailAddress,
            DEFAULT_DONG as defaultDong,
            PROFILE_PATH as profilePath,
            TO_CHAR(ENROLL_DATE, 'YYYY"년" MM"월" DD"일"') AS enrollDate,
            SECESSIONFL as secessionFl,
            IS_ADMIN as isAdmin
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
          AND SECESSIONFL = 'N'
    </select>

    <!-- 회원 정보 조회 (비밀번호 포함) -->
    <select id="selectMemberWithPassword" parameterType="int" resultType="Member">
        SELECT 
            MEMBER_NO as memberNo,
            MEMBER_EMAIL as memberEmail,
            MEMBER_PW as memberPw,
            MEMBER_NAME as memberName,
            MEMBER_NICKNAME as memberNickname,
            MEMBER_TEL as memberTel
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
          AND SECESSIONFL = 'N'
    </select>

    <!-- 프로필 정보 업데이트 (이거 하나만 있어야 함!) -->
    <update id="updateProfile" parameterType="Member">
        UPDATE MEMBER
        SET
            MEMBER_NICKNAME = #{memberNickname},
            MEMBER_TEL = #{memberTel},
            POST_CODE = #{postCode},
            LOAD_ADDRESS = #{loadAddress},
            DETAIL_ADDRESS = #{detailAddress},
            DEFAULT_DONG = #{defaultDong},
            PROFILE_PATH = #{profilePath}
            <if test="memberPw != null and memberPw != ''">
            , MEMBER_PW = #{memberPw}
            </if>
        WHERE MEMBER_NO = #{memberNo}
    </update>
    
    <!-- 회원 탈퇴 -->
	<update id="secession" parameterType="_int">
		UPDATE MEMBER SET
		SECESSIONFL = 'Y'
		WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<!-- 암호화된 비밀번호 조회 (회원 탈퇴 시 비밀번호 확인용) -->
	<select id="selectEncPw" parameterType="int" resultType="String">
    SELECT MEMBER_PW
    FROM MEMBER
    WHERE MEMBER_NO = #{memberNo}
    AND SECESSIONFL = 'N'
	</select>
	
	<!-- 굿즈 거래내역 목록 조회 -->
	<select id="selectGoods" parameterType="int" resultType="map">
		SELECT
		    oi.ORDER_ITEM_ID AS orderItemId,
		    o.ORDER_NO AS orderNo,
		    s.RECIPIENT_NAME AS recipientName,
		    s.RECIPIENT_TEL AS recipientTel,
		    s.POSTCODE AS postcode,
		    s.ADDRESS_BASE AS addressBase,
		    s.ADDRESS_DETAIL AS addressDetail,
		    s.TRACKING_NUMBER AS trackingNumber,
		    s.DELIVERY_STATUS AS 구매상태,
		    b.BOARD_TITLE AS 제품명,
		    oi.UNIT_PRICE AS 단가,
		    oi.ORDER_QUANTITY AS 수량,
		    (oi.UNIT_PRICE * oi.ORDER_QUANTITY) AS 총가격,
		    p.PAT_DATE AS 결제날짜,
		    p.PAY_METHOD AS payMethod,
		    p.PRICE AS price
		FROM ORDER_ITEM oi
		INNER JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
		LEFT JOIN SHIPPING s ON o.ORDER_NO = s.ORDER_NO
		LEFT JOIN PAYMENT p ON o.ORDER_NO = p.ORDER_NO
		LEFT JOIN BOARD b ON oi.ORDER_ITEM_NO = b.BOARD_NO
		WHERE o.MEMBER_NO = #{memberNo}
		
		<if test="keyword != null and keyword != ''">
			AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
		</if>
		
		ORDER BY p.PAT_DATE DESC

	</select>
	
	<!-- 굿즈 거래 전체 개수 조회 (추가!) -->
		<select id="getGoodsListCount" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM ORDER_ITEM oi
		INNER JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
		LEFT JOIN BOARD b ON oi.ORDER_ITEM_NO = b.BOARD_NO
		WHERE o.MEMBER_NO = #{memberNo}
		<if test="keyword != null and keyword != ''">
		    AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
</if>
</select>
	
<!-- 굿즈 거래내역 목록 조회 (페이지네이션 - RowBounds) -->
<select id="selectGoodsList" parameterType="map" resultType="map">
SELECT
    oi.ORDER_ITEM_ID AS orderItemId,
    o.ORDER_NO AS orderNo,
    s.RECIPIENT_NAME AS recipientName,
    s.RECIPIENT_TEL AS recipientTel,
    s.POSTCODE AS postcode,
    s.ADDRESS_BASE AS addressBase,
    s.ADDRESS_DETAIL AS addressDetail,
    s.TRACKING_NUMBER AS trackingNumber,
    s.DELIVERY_STATUS AS 구매상태,
    b.BOARD_TITLE AS 제품명,
    oi.UNIT_PRICE AS 단가,
    oi.ORDER_QUANTITY AS 수량,
    (oi.UNIT_PRICE * oi.ORDER_QUANTITY) AS 총가격,
    p.PAT_DATE AS 결제날짜,
    p.PAY_METHOD AS payMethod,
    p.PRICE AS price,
    b.BOARD_CONTENT AS imagePath
FROM ORDER_ITEM oi
INNER JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
LEFT JOIN SHIPPING s ON o.ORDER_NO = s.ORDER_NO
LEFT JOIN PAYMENT p ON o.ORDER_NO = p.ORDER_NO
LEFT JOIN BOARD b ON oi.ORDER_ITEM_NO = b.BOARD_NO
WHERE o.MEMBER_NO = #{memberNo}
<if test="keyword != null and keyword != ''">
    AND b.BOARD_TITLE LIKE '%' || #{keyword} || '%'
</if>
ORDER BY p.PAT_DATE DESC
</select>

<!-- 구매 확정 -->
<update id="confirmPurchase" parameterType="map">
    UPDATE SHIPPING
    SET DELIVERY_STATUS = '구매확정'
    WHERE ORDER_NO = (
        SELECT o.ORDER_NO
        FROM ORDER_ITEM oi
        JOIN "ORDER" o ON oi.ORDER_NO = o.ORDER_NO
        WHERE oi.ORDER_ITEM_ID = #{orderItemId}
          AND o.MEMBER_NO = #{memberNo}
    )
</update>
	
</mapper>
