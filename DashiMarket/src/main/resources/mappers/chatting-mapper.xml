<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.chatting.model.dao.ChattingMapper">

	<resultMap type="ChattingRoom" id="chattingRoom_rm">
		<id property="chattingNo" column="CHATTING_NO"/>
		<result property="lastMessage" column="LAST_MESSAGE" />
		<result property="sendTime" column="SEND_TIME" />
		<result property="targetNo" column="TARTGET_NO" />
		<result property="targetNickName" column="TARGET_NICKNAME" />
		<result property="targetProfile" column="TARGET_PROFILE" />
		<result property="notReadCount" column="NOT_READ_COUNT" />
	</resultMap>
	

	<!-- 채팅방 입장(채팅방 존재 여부 확인 -> 채팅방 번호 조회)  -->
	<select id="checkChattingNo" resultType="_int">
		SELECT NVL(SUM(CHATTING_NO), 0) FROM CHATTING_ROOM
		WHERE (OPEN_MEMBER = ${targetNo} AND PARTCIPANT = ${loginMemberNo})
		OR (OPEN_MEMBER = ${loginMemberNo} AND PARTCIPANT = ${targetNo})
	</select>
	
	
	<!-- 채팅방 생성 -->
	<insert id="createChattingRoom" parameterType="map" useGeneratedKeys="true">
		<selectKey order="BEFORE" resultType="_int" keyProperty="chattingNo">
			SELECT SEQ_ROOM_NO.NEXTVAL FROM DUAL
		</selectKey>
		
		INSERT INTO CHATTING_ROOM
		VALUES(${chattingNo}, DEFAULT, ${targetNo}, ${loginMemberNo})
										<!-- 참여자          개설자  -->		
	</insert>
	
	<!-- 채팅방 목록 조회 -->
	<select id="selectRoomList" resultType="ChattingRoom">
		SELECT CHATTING_NO, 

		    -- 가장 최근 메세지
		    (SELECT MESSAGE_CONTENT FROM 
		        (SELECT ROWNUM, M.* FROM CHATTING_MESSAGE M
		            WHERE M.CHATTING_NO = R.CHATTING_NO
		            ORDER BY MESSAGE_NO DESC)    
		        WHERE ROWNUM = 1) LAST_MESSAGE,
		    
		    -- 최근에 채팅 보낸 시간
		    (SELECT TO_CHAR(MAX(SEND_TIME), 'YYYY.MM.DD') SEND_TIME 
		    FROM CHATTING_MESSAGE M
		    WHERE M.CHATTING_NO = R.CHATTING_NO) SEND_TIME,
		    
		    -- 타겟 회원 번호
		    NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
		        WHERE R2.CHATTING_NO = R.CHATTING_NO
		        AND OPEN_MEMBER = ${memberNo}), PARTCIPANT, OPEN_MEMBER) TARGET_NO,
		    
		    -- 타겟 회원 닉네임
		    NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
		            WHERE R2.CHATTING_NO = R.CHATTING_NO
		            AND OPEN_MEMBER = ${memberNo}), 
		            (SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO = R.PARTCIPANT), 
		            (SELECT MEMBER_NICKNAME FROM MEMBER WHERE MEMBER_NO = R.OPEN_MEMBER)) TARGET_NICKNAME,
		    
		    -- 타겟 회원 프로필 이미지        
		    NVL2((SELECT OPEN_MEMBER FROM CHATTING_ROOM R2
		            WHERE R2.CHATTING_NO = R.CHATTING_NO
		            AND OPEN_MEMBER = ${memberNo}), 
		            (SELECT PROFILE_PATH FROM MEMBER WHERE MEMBER_NO = R.PARTCIPANT), 
		            (SELECT PROFILE_PATH FROM MEMBER WHERE MEMBER_NO = R.OPEN_MEMBER)) TARGET_PROFILE,
		            
		    -- 읽지 않고 받은 메세지 수
		    (SELECT COUNT(*) FROM CHATTING_MESSAGE M
		    WHERE READ_FL = 'N'
		    AND M.CHATTING_NO = R.CHATTING_NO
		    AND SEND_MEMBER != ${memberNo}) NOT_READ_COUNT,
		    
		    -- 최근 메세지 번호(정렬)
		    (SELECT MAX(MESSAGE_NO) FROM CHATTING_MESSAGE M
		    WHERE M.CHATTING_NO = R.CHATTING_NO) MAX_MESSAGE_NO
		
		FROM CHATTING_ROOM R
		WHERE OPEN_MEMBER = ${memberNo} OR PARTCIPANT = ${memberNo}
		ORDER BY MAX_MESSAGE_NO DESC NULLS LAST
	</select>
	
	
	
	
</mapper>