<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.joonggo.model.dao.JoonggoMapper">
	
	<resultMap type="Joonggo" id="joonggo_rm">
   
      <id property="joonggoNo" column="BOARD_NO"/>
      
      <result property="joonggoTitle" column="BOARD_TITLE"/>
      <result property="joonggoContent" column="BOARD_CONTENT"/>
      <result property="joonggoCreateDate" column="BOARD_CREATE_DATE"/>
      <result property="joonggoUpdateDate" column="BOARD_UPDATE_DATE"/>
      <result property="readCount" column="POST_VIEWS"/>
      <result property="likeCount" column="LIKE_COUNT"/>
      <result property="joonggoPrice" column="JOONGGO_PRICE" />
      <result property="thumbnail" column="THUMBNAIL" />
      
      
      <!--회원 -->
      <result property="memberNickname" column="MEMBER_NICKNAME"/>
      <result property="memberNo" column="MEMBER_NO"/>
      <result property="profileImage" column="PROFILE_PATH"/>
      <result property="defaultDong" column="DEFAULT_DONG"/>
      
      <!--카테고리-->
      <result property="categoryId" column="CATEGORY_ID"/>
      <result property="mainCategory" column="MAIN"/>
      <result property="subCategory" column="SUB"/>
      
            
      <result property="boardCode" column="BOARD_CODE"/>
      <result property="boardType" column="BOARD_TYPE"/>
      
       
        
       
      
      
      <!-- collection 태그  
		- select로 조회된 결과를 컬렉션(List)에 담아 지정된 필드에 세팅
        - property : list에 담을 DTO 필드명
        - select : 실행할 select의 id 	 
        - column : 조회 결과 중 지정된 컬럼의 값을 파라미터로 전달
        - javaType : List(컬렉션)의 타입 지정 
        - ofType : List(컬레션)의 제네릭 지정
      -->
      <collection property="imageList" select="selectImageList" 
      			  column="BOARD_NO" javaType="java.util.ArrayList"  
      			  ofType="Image" 
      			  >     
      </collection>
      
      
   </resultMap>
   
   <!-- 비슷한 아이템 목록-->
   <resultMap id="similar_rm" type="SimilarItem">
		 <id property="joonggoNo" column="BOARD_NO"/>
		 <result property="joonggoTitle" column="BOARD_TITLE"/>
		 <result property="imagePath" column="IMG_PATH" />		   
		 <result property="imageRename" column="IMG_RENAME" />		   
		 <result property="joonggoPrice" column="JOONGGO_PRICE"/>
   </resultMap>
   
   
   <!--이미지 rm-->
   <resultMap id="image_rm" type="Image">
	   
	  <id property="imageNo" column="IMG_NO"/>
      
      <result property="imagePath" column="IMG_PATH"/>
      <result property="imageRename" column="IMG_RENAME"/>
      <result property="imageOrder" column="IMG_ORDER"/>
      <result property="boardNo" column="BOARD_NO"/>   
   </resultMap>
   
   
   <!-- 게시글 수 조회 (KJK) -->
	<select id="getJoonggoListCount">
		SELECT COUNT(*) FROM BOARD
		JOIN BOARD_TYPE USING(BOARD_CODE)
		WHERE BOARD_TYPE = #{boardType}
		AND DELETE_FL = 'N'
	</select>
	
	<!-- 중고상품 목록 조회 (KJK) -->
	<select id="selectJoonggoList" resultMap="joonggo_rm">

		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, JOONGGO_PRICE,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "JOONGGO" J ON(J.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'joonggo'
		ORDER BY BOARD_CREATE_DATE DESC
	</select>
	
	<!-- 중고상품 카테고리 목록 조회 (KJK) -->
	<select id="selectJoonggoCategoryList" resultMap="joonggo_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, BOARD_TYPE, TO_CHAR(JOONGGO_PRICE, '999,999,999,999')||'원' JOONGGO_PRICE,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "JOONGGO" J ON(J.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'joonggo'
		AND CATEGORY_ID = #{categoryId}
		ORDER BY BOARD_CREATE_DATE DESC
	</select>
	
	
		<!-- 중고상품 목록 정렬 : 인기순(조회순?) (KJK) -->
	<select id="sortJoonggoViews" resultMap="joonggo_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS,  JOONGGO_PRICE,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "JOONGGO" J ON(J.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'joonggo'
		ORDER BY POST_VIEWS DESC
	</select>
	
		<!-- 중고상품 목록 정렬 : 낮은 가격순 (KJK) -->
	<select id="sortJoonggoLowPrice" resultMap="joonggo_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS,  JOONGGO_PRICE,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "JOONGGO" J ON(J.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'joonggo'
		ORDER BY JOONGGO_PRICE ASC
	</select>
	
		<!-- 중고상품 목록 정렬 : 높은 가격순 (KJK) -->
	<select id="sortJoonggoHighPrice" resultMap="joonggo_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS,  JOONGGO_PRICE,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "JOONGGO" J ON(J.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'joonggo'
		ORDER BY JOONGGO_PRICE DESC
	</select>
	
	
	 <!-- 중고상품 위시리스트 목록 조회 (KJK) -->
	<select id="selectJoonggoWishList" resultMap="joonggo_rm">
		SELECT B.BOARD_NO, BOARD_TITLE,  JOONGGO_PRICE,
		  (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		FROM "BOARD" B
		JOIN "JOONGGO" J ON(J.BOARD_NO = B.BOARD_NO)
		JOIN "LIKE" L ON(L.POST_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_CODE = 1
		AND L.MEMBER_NO = ${memberNo}
		ORDER BY BOARD_CREATE_DATE DESC
	</select>
	
	<!-- 찜한 중고상품목록 삭제 (KJK) -->
	<delete id="deleteJoonggoWishList">
		DELETE FROM "LIKE"
		WHERE POST_NO = #{boardNo}
		AND MEMBER_NO = ${memberNo}
	</delete>


	
	
	<select id="selectJoonggoDetail" resultMap="joonggo_rm">
		SELECT BOARD_NO, BOARD_TITLE, BOARD_CONTENT,
				<![CDATA[
				CASE    
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 / 60 THEN 
			            CASE WHEN SYSDATE - B.BOARD_CREATE_DATE < 5 / 24 / 60 / 60
			                 THEN '방금 전'
			                 ELSE FLOOR( (SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전' 
			            END
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 THEN
			            FLOOR( (SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 ) || '분 전'
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 THEN 
			            FLOOR( (SYSDATE - B.BOARD_CREATE_DATE) * 24 ) || '시간 전'
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 7 THEN 
			            FLOOR( SYSDATE - B.BOARD_CREATE_DATE ) || '일 전'
			        ELSE TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD')
			    END AS BOARD_CREATE_DATE
			    ]]>	 
				 , BOARD_UPDATE_DATE, POST_VIEWS, BOARD_CODE, MEMBER_NO, B.CATEGORY_ID, SUB.CATEGORY_NAME SUB, MAIN.CATEGORY_NAME MAIN,
        		MEMBER_NICKNAME, PROFILE_PATH, JOONGGO_PRICE, BOARD_TYPE, DEFAULT_DONG
        		, (SELECT COUNT(*) FROM "LIKE"
        			WHERE POST_NO = BOARD_NO) LIKE_COUNT
		FROM BOARD B
		JOIN CATEGORY SUB ON(B.CATEGORY_ID = SUB.CATEGORY_ID)
		JOIN CATEGORY MAIN ON(SUB.PARENT_CATEGORY_NO = MAIN.CATEGORY_ID)
		JOIN MEMBER USING(MEMBER_NO)
		JOIN JOONGGO USING(BOARD_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		WHERE BOARD_NO = #{joonggoNo}
		AND DELETE_FL = 'N'
				
	</select>
	
	<select id="selectImageList" resultMap ="image_rm">
		SELECT * FROM IMAGE
		WHERE BOARD_NO = #{boardNo}
		ORDER BY IMG_ORDER	
	</select>
	
	
	<!-- 비슷한 아이템 목록 조회-->
	<select id="selectJonggoList" resultMap="similar_rm">
		SELECT * 
		FROM (SELECT BOARD_NO, BOARD_TITLE, IMG_PATH, IMG_RENAME, JOONGGO_PRICE 
		        FROM BOARD
		        JOIN JOONGGO USING(BOARD_NO)
		        JOIN IMAGE USING(BOARD_NO)
		        WHERE CATEGORY_ID = #{categoryId}
		        AND BOARD_NO != #{boardNo}
		        AND DELETE_FL = 'N'
		        AND IMG_ORDER = 0
		        ORDER BY DBMS_RANDOM.VALUE)
		 <![CDATA[
		 	WHERE ROWNUM <= 20
		  ]]>
		
		
	</select>
	
	
	<!-- 중고 상품 삭제-->
	<update id="deleteJoonggoItem">
		
		UPDATE BOARD SET
		DELETE_FL ='Y'
		WHERE BOARD_NO = #{joonggoNo}
		
	</update>	
	
	
	<!--
		<selectKey order="BEFORE" resultType="_int" keyProperty="boardNo">
			SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
		</selectKey>
	
	
	-->
	
	<!-- 중고 상품 삽입-->
	<insert id="joonggoInsert" parameterType="JoonggoWrite" useGeneratedKeys="true">
		
		<selectKey order="BEFORE" resultType="string" keyProperty="joonggoNo" >
			SELECT 'J' || TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') || LPAD(SEQ_JOONGGO_NO.NEXTVAL, 5, '0') FROM DUAL
		</selectKey>
		
		
		INSERT INTO BOARD 
		VALUES(#{joonggoNo}
				,#{joonggoTitle}
				, #{joonggoContent}
				, SYSDATE, null, default
		        ,(SELECT BOARD_CODE FROM BOARD_TYPE 
        			WHERE BOARD_TYPE = #{boardType})
        			
    			, ${memberNo}
    			, #{categoryId}, default)
		
	</insert>
	
	<!-- 중고 상품 가격 삽입-->
	<insert id="joonggoPriceInsert">
		
		INSERT INTO JOONGGO
		VALUES (
		#{joonggoNo},
		${joonggoPrice},
		default)
		
	</insert>
	
		<!--
		동적 SQL 중 <foreach>
		- 특정 sql 문을 반복할 때 사용
		- 이 때, 반복되는 사이에 구분자(separator)를 추가할 수 있음
		
		* <foreach> 속성
		collection : 반복할 객체의 타입 작성
		item : collection 에서 순차적으로 꺼낸 하나의 요소를 저장할 변수
		index : 현재 반복 접근 중인 인덱스
		separator : 반복 사이에 넣을 구분자
	
	  -->
		
	<!--중고 이미지 삽입-->
	<insert id="insertImage">
		INSERT INTO IMAGE
		SELECT SEQ_IMAGE_NO.NEXTVAL, A.*
		
		FROM (
			<foreach collection="list" item="img" separator="UNION ALL">
				
				SELECT #{img.imagePath} IMG_PATH
						, #{img.imageRename} IMG_RENMAE
						, ${img.imageOrder} IMG_ORDER
						, #{img.boardNo} BOARD_NO
				FROM DUAL		
				
				
			</foreach>
			) A
		
		
	</insert>
	
	
	<!--중고 상품 수정-->
	<update id="joonggoUpdate">
		UPDATE BOARD SET
		BOARD_TITLE = #{joonggoTitle},
		BOARD_CONTENT = #{joonggoContent},
		BOARD_UPDATE_DATE = SYSDATE,
		CATEGORY_ID = #{categoryId}
		WHERE BOARD_NO = #{joonggoNo}	
			
	</update>
	
	<!-- 상품 가격 수정-->
	<update id="joonggoPriceUpdate">
		UPDATE JOONGGO SET
		JOONGGO_PRICE = #{joonggoPrice}
		WHERE BOARD_NO = #{joonggoNo}
		
	</update>
	
	<!-- 이미지 삭제 -->
	<delete id="imageDelete">
		DELETE FROM IMAGE
		WHERE BOARD_NO = #{joonggoNo}
		AND IMG_ORDER IN (${deleteList})	
	</delete>
	
	<!-- 이미지 순서 재정렬 -->
	<update id="sortImageOrder">
		UPDATE IMAGE SET
		IMG_ORDER =  ROWNUM-1
		WHERE BOARD_NO = #{joonggoNo}
	</update>
	
	<!-- 이미지 시작 인덱스 조회-->
	<select id="selectImageOrder" resultType="_int">
		SELECT NVL(MAX(IMG_ORDER), -1) FROM IMAGE
		WHERE BOARD_NO = #{joonggoNo}
	</select>
	
	
	
	<!-- 좋아요 추가 -->
	<insert id="likeInsert">
		INSERT INTO "LIKE"
		VALUES(#{joonggoNo}, ${memberNo})
		
	</insert>
	
	<!--좋아요 삭제 -->
	<delete id="deleteInsert">
		DELETE FROM "LIKE"
		WHERE POST_NO = #{joonggoNo}
		AND MEMBER_NO = ${memberNo}
		
	</delete>
	
	
	<!-- 좋아요 개수 확인;-->
	<select id="countLike" resultType="_int">
		SELECT COUNT(*) FROM "LIKE"
		WHERE POST_NO = #{joonggoNo}
		
	</select>
	
	
	<!--좋아여 여부 확인-->
	<select id="likeSelect" resultType="_int">
		
		SELECT COUNT(*) FROM "LIKE"
		WHERE POST_NO = #{boardNo}
		AND MEMBER_NO = ${memberNo}
		
	</select>
	
	
	<!-- 조회수 증가 -->
	<update id="updateReadCount">
		UPDATE BOARD SET
		POST_VIEWS = POST_VIEWS + 1
		WHERE BOARD_NO = #{joonggoNo}
		
		
	</update>
</mapper>