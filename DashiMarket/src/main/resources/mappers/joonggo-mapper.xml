<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.joonggo.model.dao.JoonggoMapper">
	
	<resultMap type="Joonggo" id="joonggo_rm">
   
      <id property="joonggoNo" column="BOARD_NO"/>
      
      <result property="joonggoTitle" column="BOARD_TITLE"/>
      <result property="joonggoContent" column="BOARD_CONTENT"/>
      <result property="joonggoCreateDate" column="BOARD_CREATE_DATE"/>
      <result property="joonggoUpdateDate" column="BOARD_UPDATE_DATE"/>
      <result property="readCount" column="POST_VIEWS"/>
      <result property="likeCount" column="LIKE_COUNT"/>
      <result property="joonggoPrice" column="JOONGGO_PRICE" />
      
      
      
      <!--회원 -->
      <result property="memberNickname" column="MEMBER_NICKNAME"/>
      <result property="memberNo" column="MEMBER_NO"/>
      <result property="profileImage" column="PROFILE_PATH"/>
      <result property="defaultDong" column="DEFAULT_DONG"/>
      
      <!--카테고리-->
      <result property="categoryId" column="CATEGORY_ID"/>
      <result property="mainCategory" column="MAIN"/>
      <result property="subCategory" column="SUB"/>
      
            
      <result property="boardCode" column="BOARD_CODE"/>
      <result property="boardType" column="BOARD_TYPE"/>
      
      
      <!-- collection 태그  
		- select로 조회된 결과를 컬렉션(List)에 담아 지정된 필드에 세팅
        - property : list에 담을 DTO 필드명
        - select : 실행할 select의 id 	 
        - column : 조회 결과 중 지정된 컬럼의 값을 파라미터로 전달
        - javaType : List(컬렉션)의 타입 지정 
        - ofType : List(컬레션)의 제네릭 지정
      -->
      <collection property="imageList" select="selectImageList" 
      			  column="BOARD_NO" javaType="java.util.ArrayList"  
      			  ofType="Image" 
      			  >     
      </collection>
      
      
   </resultMap>
   
   <!-- 비슷한 아이템 목록-->
   <resultMap id="similar_rm" type="SimilarItem">
		 <id property="joonggoNo" column="BOARD_NO"/>
		 <result property="joonggoTitle" column="BOARD_TITLE"/>
		 <result property="imagePath" column="IMG_PATH" />		   
		 <result property="joonggoPrice" column="JOONGGO_PRICE"/>
   </resultMap>
   
   
   <!--이미지 rm-->
   <resultMap id="image_rm" type="Image">
	   
	  <id property="imageNo" column="IMG_NO"/>
      
      <result property="imagePath" column="IMG_PATH"/>
      <result property="imageRename" column="IMG_RENAME"/>
      <result property="imageOrder" column="IMG_ORDER"/>
      <result property="boardNo" column="BOARD_NO"/>   
   </resultMap>
	
	
	
	<select id="selectJoonggoDetail" resultMap="joonggo_rm">
		SELECT BOARD_NO, BOARD_TITLE, BOARD_CONTENT,
				<![CDATA[
				CASE    
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 / 60 THEN 
			            CASE WHEN SYSDATE - B.BOARD_CREATE_DATE < 5 / 24 / 60 / 60
			                 THEN '방금 전'
			                 ELSE FLOOR( (SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전' 
			            END
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 / 24 THEN
			            FLOOR( (SYSDATE - B.BOARD_CREATE_DATE) * 24 * 60 ) || '분 전'
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 1 THEN 
			            FLOOR( (SYSDATE - B.BOARD_CREATE_DATE) * 24 ) || '시간 전'
			        WHEN SYSDATE - B.BOARD_CREATE_DATE < 7 THEN 
			            FLOOR( SYSDATE - B.BOARD_CREATE_DATE ) || '일 전'
			        ELSE TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD')
			    END AS BOARD_CREATE_DATE
			    ]]>	 
				 , BOARD_UPDATE_DATE, POST_VIEWS, BOARD_CODE, MEMBER_NO, B.CATEGORY_ID, SUB.CATEGORY_NAME SUB, MAIN.CATEGORY_NAME MAIN,
        		MEMBER_NICKNAME, PROFILE_PATH, JOONGGO_PRICE, BOARD_TYPE, DEFAULT_DONG
        		, (SELECT COUNT(*) FROM "LIKE"
        			WHERE POST_NO = BOARD_NO) LIKE_COUNT
		FROM BOARD B
		JOIN CATEGORY SUB ON(B.CATEGORY_ID = SUB.CATEGORY_ID)
		JOIN CATEGORY MAIN ON(SUB.PARENT_CATEGORY_NO = MAIN.CATEGORY_ID)
		JOIN MEMBER USING(MEMBER_NO)
		JOIN JOONGGO USING(BOARD_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		WHERE BOARD_NO = #{joonggoNo}
		AND DELETE_FL = 'N'
				
	</select>
	
	<select id="selectImageList" resultMap ="image_rm">
		SELECT * FROM IMAGE
		WHERE BOARD_NO = #{joonggoNo}
		ORDER BY IMG_ORDER	
	</select>
	
	
	<!-- 비슷한 아이템 목록 조회-->
	<select id="selectJonggoList" resultMap="similar_rm">
		SELECT * 
		FROM (SELECT BOARD_NO, BOARD_TITLE, IMG_PATH, JOONGGO_PRICE 
		        FROM BOARD
		        JOIN JOONGGO USING(BOARD_NO)
		        JOIN IMAGE USING(BOARD_NO)
		        WHERE CATEGORY_ID = #{categoryId}
		        AND BOARD_NO != #{boardNo}
		        AND DELETE_FL = 'N'
		        AND IMG_ORDER = 0
		        ORDER BY DBMS_RANDOM.VALUE)
		 <![CDATA[
		 	WHERE ROWNUM <= 20
		  ]]>
		
		
	</select>
	
	
	<!-- 중고 상품 삭제-->
	<update id="deleteJoonggoItem">
		
		UPDATE BOARD SET
		DELETE_FL ='Y'
		WHERE BOARD_NO = #{joonggoNo}
		
	</update>	
	
	
	
	
</mapper>