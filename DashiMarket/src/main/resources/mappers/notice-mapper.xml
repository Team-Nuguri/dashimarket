<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.notice.model.dao.NoticeMapper">

    <!-- 공지사항 목록 조회 (검색 + 페이징) - 최신글이 맨 위 -->
	<select id="selectNoticeList" resultType="edu.og.project.notice.model.dto.Notice">
	    SELECT
	        BOARD_NO AS noticeNo,
	        BOARD_TITLE AS noticeTitle,
	        TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD') AS noticeCreateDate,
	        POST_VIEWS AS readCount
	    FROM BOARD
	    WHERE BOARD_CODE = 4
	    AND DELETE_FL = 'N'
	    <if test="query != null and query != ''">
	        AND BOARD_TITLE LIKE '%' || #{query} || '%'
	    </if>
	    ORDER BY BOARD_CREATE_DATE DESC, TO_NUMBER(BOARD_NO) DESC
	    OFFSET #{offset} ROWS
	    FETCH NEXT #{pageSize} ROWS ONLY
	</select>


    <!-- 공지사항 전체 개수 조회 (검색 포함) -->
    <select id="getNoticeCount" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE BOARD_CODE = 4
        AND DELETE_FL = 'N'
        <if test="query != null and query != ''">
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
        </if>
    </select>

    <!-- 공지사항 상세 조회 - ATTACHMENT_PATH 추가 -->
    <select id="selectNoticeDetail" resultType="edu.og.project.notice.model.dto.Notice">
        SELECT
            BOARD_NO AS noticeNo,
            BOARD_TITLE AS noticeTitle,
            BOARD_CONTENT AS noticeContent,
            TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD') AS noticeCreateDate,
            POST_VIEWS AS readCount,
            BOARD_CODE AS boardCode,
            ATTACHMENT_PATH AS attachmentPath,
            CASE 
                WHEN BOARD_CODE = 4 THEN 'notice'
                WHEN BOARD_CODE = 5 THEN 'faq'
            END AS boardType
        FROM BOARD
        WHERE BOARD_NO = #{noticeNo}
        AND BOARD_CODE = 4
        AND DELETE_FL = 'N'
    </select>

    <!-- 공지사항 글 등록 - ATTACHMENT_PATH 추가 -->
    <insert id="insertNotice" parameterType="edu.og.project.notice.model.dto.Notice">
        INSERT INTO BOARD (
            BOARD_NO,
            BOARD_TITLE,
            BOARD_CONTENT,
            BOARD_CREATE_DATE,
            POST_VIEWS,
            BOARD_CODE,
            MEMBER_NO,
            DELETE_FL,
            ATTACHMENT_PATH
        ) VALUES (
            SEQ_NOTICE_NO.NEXTVAL,
            #{noticeTitle},
            #{noticeContent},
            SYSDATE,
            0,
            #{boardCode},
            1,
            'N',
            #{attachmentPath}
        )
    </insert>

    <!-- 이전글 조회 -->
    <select id="selectPrevNotice" resultType="edu.og.project.notice.model.dto.Notice">
        SELECT
            BOARD_NO AS noticeNo,
            BOARD_TITLE AS noticeTitle
        FROM BOARD
        WHERE BOARD_NO <![CDATA[<]]> #{noticeNo}
        AND BOARD_CODE = 4
        AND DELETE_FL = 'N'
        ORDER BY BOARD_NO DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 다음글 조회 -->
    <select id="selectNextNotice" resultType="edu.og.project.notice.model.dto.Notice">
        SELECT
            BOARD_NO AS noticeNo,
            BOARD_TITLE AS noticeTitle
        FROM BOARD
        WHERE BOARD_NO > #{noticeNo}
        AND BOARD_CODE = 4
        AND DELETE_FL = 'N'
        ORDER BY BOARD_NO ASC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 공지사항 수정 - ATTACHMENT_PATH 추가 -->
    <update id="updateNotice" parameterType="edu.og.project.notice.model.dto.Notice">
        UPDATE BOARD
        SET
            BOARD_TITLE = #{noticeTitle},
            BOARD_CONTENT = #{noticeContent},
            BOARD_CODE = #{boardCode}
            <if test="attachmentPath != null and attachmentPath != ''">
            , ATTACHMENT_PATH = #{attachmentPath}
            </if>
        WHERE BOARD_NO = #{noticeNo}
        AND DELETE_FL = 'N'
    </update>

    <!-- 공지사항 삭제 (논리 삭제) -->
    <update id="deleteNotice">
        UPDATE BOARD
        SET DELETE_FL = 'Y'
        WHERE BOARD_NO = #{noticeNo}
        AND BOARD_CODE = 4
    </update>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount">
        UPDATE BOARD
        SET POST_VIEWS = POST_VIEWS + 1
        WHERE BOARD_NO = #{noticeNo}
        AND BOARD_CODE = 4
        AND DELETE_FL = 'N'
    </update>

</mapper>