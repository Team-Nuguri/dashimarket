<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.notice.model.dao.NoticeMapper">

    <!-- 공지사항 목록 조회 -->
    <select id="selectNoticeList" resultType="edu.og.project.notice.model.dto.Notice">
        SELECT
            BOARD_NO AS noticeNo,
            BOARD_TITLE AS noticeTitle,
            TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD') AS noticeCreateDate,
            POST_VIEWS AS readCount
        FROM BOARD
        WHERE BOARD_CODE = 4
        AND DELETE_FL = 'N'
        <if test="query != null and query != ''">
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
        </if>
        ORDER BY BOARD_CREATE_DATE DESC, TO_NUMBER(BOARD_NO) DESC
        OFFSET #{offset} ROWS
        FETCH NEXT #{pageSize} ROWS ONLY
    </select>

    <!-- 공지사항 전체 개수 조회 -->
    <select id="getNoticeCount" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE BOARD_CODE = 4
        AND DELETE_FL = 'N'
        <if test="query != null and query != ''">
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
        </if>
    </select>

    <!-- 공지사항 상세 조회 (이미지 포함) -->
    <resultMap id="NoticeResultMap" type="edu.og.project.notice.model.dto.Notice">
        <id property="noticeNo" column="BOARD_NO"/>
        <result property="noticeTitle" column="BOARD_TITLE"/>
        <result property="noticeContent" column="BOARD_CONTENT"/>
        <result property="noticeCreateDate" column="NOTICE_CREATE_DATE"/>
        <result property="readCount" column="POST_VIEWS"/>
        <result property="boardCode" column="BOARD_CODE"/>
        <result property="boardType" column="BOARD_TYPE"/>
        
        <!-- 1:N 관계 - 이미지 리스트 -->
        <collection property="imageList" ofType="edu.og.project.common.dto.Image">
            <id property="imageNo" column="IMG_NO"/>
            <result property="imagePath" column="IMG_PATH"/>
            <result property="imageRename" column="IMG_RENAME"/>
            <result property="imageOrder" column="IMG_ORDER"/>
            <result property="boardNo" column="IMG_BOARD_NO"/>
        </collection>
    </resultMap>
    
    <select id="selectNoticeDetail" parameterType="int" resultMap="NoticeResultMap">
        SELECT
            B.BOARD_NO AS BOARD_NO,
            B.BOARD_TITLE,
            B.BOARD_CONTENT,
            TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD') AS NOTICE_CREATE_DATE,
            B.POST_VIEWS,
            B.BOARD_CODE,
            CASE 
                WHEN B.BOARD_CODE = 4 THEN 'notice'
                WHEN B.BOARD_CODE = 5 THEN 'faq'
            END AS BOARD_TYPE,
            I.IMG_NO,
            I.IMG_PATH,
            I.IMG_RENAME,
            I.IMG_ORDER,
            I.BOARD_NO AS IMG_BOARD_NO
        FROM BOARD B
        LEFT JOIN IMAGE I ON B.BOARD_NO = I.BOARD_NO
        WHERE B.BOARD_NO = TO_CHAR(#{noticeNo})
        AND B.BOARD_CODE = 4
        AND B.DELETE_FL = 'N'
        ORDER BY NVL(I.IMG_ORDER, 0) ASC
    </select>

    <!-- 공지사항 글 등록 (selectKey로 noticeNo 미리 생성) -->
    <insert id="insertNotice" parameterType="edu.og.project.notice.model.dto.Notice">
        <selectKey keyProperty="noticeNo" resultType="string" order="BEFORE">
            SELECT TO_CHAR(SEQ_NOTICE_NO.NEXTVAL) FROM DUAL
        </selectKey>
        
        INSERT INTO BOARD (
            BOARD_NO,
            BOARD_TITLE,
            BOARD_CONTENT,
            BOARD_CREATE_DATE,
            POST_VIEWS,
            BOARD_CODE,
            MEMBER_NO,
            DELETE_FL
        ) VALUES (
            #{noticeNo},
            #{noticeTitle},
            #{noticeContent},
            SYSDATE,
            0,
            #{boardCode},
            #{memberNo},
            'N'
        )
    </insert>
    
    <!-- 이미지 등록 -->
    <insert id="insertImage" parameterType="edu.og.project.common.dto.Image">
        INSERT INTO IMAGE (
            IMG_NO,
            IMG_PATH,
            IMG_RENAME,
            IMG_ORDER,
            BOARD_NO
        ) VALUES (
            SEQ_IMAGE_NO.NEXTVAL,
            #{imagePath},
            #{imageRename},
            #{imageOrder},
            #{boardNo}
        )
    </insert>

    <!-- 이전글 조회 -->
    <select id="selectPrevNotice" parameterType="int" resultType="edu.og.project.notice.model.dto.Notice">
        SELECT
            BOARD_NO AS noticeNo,
            BOARD_TITLE AS noticeTitle
        FROM BOARD
        WHERE TO_NUMBER(BOARD_NO) <![CDATA[<]]> #{noticeNo}
        AND BOARD_CODE = 4
        AND DELETE_FL = 'N'
        ORDER BY TO_NUMBER(BOARD_NO) DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 다음글 조회 -->
    <select id="selectNextNotice" parameterType="int" resultType="edu.og.project.notice.model.dto.Notice">
        SELECT
            BOARD_NO AS noticeNo,
            BOARD_TITLE AS noticeTitle
        FROM BOARD
        WHERE TO_NUMBER(BOARD_NO) > #{noticeNo}
        AND BOARD_CODE = 4
        AND DELETE_FL = 'N'
        ORDER BY TO_NUMBER(BOARD_NO) ASC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 공지사항 수정 -->
    <update id="updateNotice" parameterType="edu.og.project.notice.model.dto.Notice">
        UPDATE BOARD
        SET
            BOARD_TITLE = #{noticeTitle},
            BOARD_CONTENT = #{noticeContent},
            BOARD_CODE = #{boardCode}
        WHERE BOARD_NO = #{noticeNo}
        AND DELETE_FL = 'N'
    </update>
    
    <!-- 게시글에 연결된 이미지 삭제 -->
    <delete id="deleteImagesByBoardNo" parameterType="String">
        DELETE FROM IMAGE
        WHERE BOARD_NO = #{boardNo}
    </delete>

    <!-- 공지사항 삭제 (논리 삭제) -->
    <update id="deleteNotice" parameterType="int">
        UPDATE BOARD
        SET DELETE_FL = 'Y'
        WHERE BOARD_NO = TO_CHAR(#{noticeNo})
        AND BOARD_CODE = 4
    </update>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount" parameterType="int">
        UPDATE BOARD
        SET POST_VIEWS = POST_VIEWS + 1
        WHERE BOARD_NO = TO_CHAR(#{noticeNo})
        AND BOARD_CODE = 4
        AND DELETE_FL = 'N'
    </update>

</mapper>
