<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.goods.model.dao.GoodsMapper">

    <resultMap type="edu.og.project.goods.model.dto.Goods" id="goodsResultMap">
    
        <id     property="boardNo"         column="BOARD_NO"/>
        
        <result property="goodsPrice"      column="GOODS_PRICE"/>
        <result property="goodsStock"      column="GOODS_STOCK"/>
        
        <result property="boardTitle"      column="BOARD_TITLE"/>
        <result property="boardContent"    column="BOARD_CONTENT"/>
        <result property="boardCreateDate" column="BOARD_CREATE_DATE"/>
        <result property="boardUpdateDate" column="BOARD_UPDATE_DATE"/>
        <result property="postViews"       column="POST_VIEWS"/>
        <result property="boardCode"       column="BOARD_CODE"/>
		<result property="thumbnail" column="THUMBNAIL"/>
        
        <result property="commentCount"    column="COMMENT_COUNT"/>
        <result property="likeCount"       column="LIKE_COUNT"/>
        
        <collection property="thumbnail" 
                    ofType="Image"
                    column="BOARD_NO" 
                    select="selectImageList" /> 
        
        <collection property="commentList" 
                    ofType="Comment"
                    column="BOARD_NO" 
                    select="selectCommentList" />
    </resultMap>

	<!-- 게시글 수 조회 -->
	<select id="getListCount">
		SELECT COUNT(*) FROM BOARD
		JOIN BOARD_TYPE USING(BOARD_CODE)
		WHERE BOARD_TYPE = #{boardType}
		AND DELETE_FL = 'N'
	</select>
	
	<!-- 굿즈 목록 조회 -->
	<select id="selectGoodsList">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, TO_CHAR(GOODS_PRICE, '999,999,999,999')||'원' GOODS_PRICE, GOODS_STOCK,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "GOODS" G ON(G.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'goods'
		ORDER BY BOARD_NO DESC
	</select>
</mapper>