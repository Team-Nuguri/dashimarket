<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.goods.model.dao.GoodsMapper">

    <resultMap type="edu.og.project.goods.model.dto.Goods" id="goodsResultMap">
    
        <id     property="boardNo"         column="BOARD_NO"/>
        
        <result property="goodsPrice"      column="GOODS_PRICE"/>
        <result property="goodsStock"      column="GOODS_STOCK"/>
        
        <result property="boardTitle"      column="BOARD_TITLE"/>
        <result property="boardContent"    column="BOARD_CONTENT"/>
        <result property="boardCreateDate" column="BOARD_CREATE_DATE"/>
        <result property="boardUpdateDate" column="BOARD_UPDATE_DATE"/>
        <result property="postViews"       column="POST_VIEWS"/>
        <result property="boardCode"       column="BOARD_CODE"/>
        
        <result property="commentCount"    column="COMMENT_COUNT"/>
        <result property="likeCount"       column="LIKE_COUNT"/>
        <result property="reviewCount"       column="REVIEW_COUNT"/>
        <result property="avgRating"       column="AVG_RATING"/>
        
        
        <!-- 대표 이미지 -->
		<result property="thumbnail" 	   column="THUMBNAIL"/>
        
        <association property="image" select="selectImageList" 
             column="BOARD_NO" 
             javaType="Image" > 
		</association>
        
        
        
        
       <!-- <collection property="thumbnail" 
                    ofType="Image"
                    column="BOARD_NO" 
                    select="selectImageList" /> 
        
        <collection property="commentList" 
                    ofType="Comment"
                    column="BOARD_NO" 
                    select="selectCommentList" />-->
    </resultMap>
    
    
    
    <!--이미지 rm-->
   <resultMap id="image_rm" type="Image">
	   
	  <id property="imageNo" column="IMG_NO"/>
      
      <result property="imagePath" column="IMG_PATH"/>
      <result property="imageRename" column="IMG_RENAME"/>
      <result property="imageOrder" column="IMG_ORDER"/>
      <result property="boardNo" column="BOARD_NO"/>   
   </resultMap>
   
   <!-- 리뷰 RM-->
   <resultMap id="review_rm" type="Review">
	   
	  <id property="reviewNo" column="REVIEW_NO"/>
      
      <result property="comment" column="COMMENT"/>
      <result property="reviewCreateDate" column="REVIEW_DATE"/>
      <result property="reviewImgPath" column="REVIEW_FILE_PATH"/>
      <result property="reviewImgRename" column="REVIEW_FILE_NAME"/>   
      <result property="buyerNo" column="BUYER_NO"/>   
      <result property="boardNo" column="BOARD_NO"/>   
      <result property="rating" column="RATING"/>   
   </resultMap>
   
     <!-- qna RM-->
   <resultMap id="comment_rm" type="Comment">
	   
	  <id property="commentNo" column="COMMENT_NO"/>
      
      <result property="postNo" column="POST_NO"/>
      <result property="parentCommentNo" column="PARENT_COMMENT_NO"/>
      <result property="commentContent" column="COMMENT_CONTENT"/>
      <result property="commentCreateDate" column="COMMENT_CREATE_DATE"/>
      <result property="commentStatus" column="COMMENT_STATUS"/>   
      <result property="memberNo" column="MEMBER_NO"/>   
      <result property="memberNickname" column="MEMBER_NICKNAME"/>   
      <result property="level" column="LEVEL"/>   
      
   </resultMap>
   
   <!-- 다른 굿즈 목록 조회-->
     <resultMap id="othergoods_rm" type="OtherGoods">
		 <id property="goodsNo" column="BOARD_NO"/>
		 <result property="goodsTitle" column="BOARD_TITLE"/>
		 <result property="imagePath" column="IMG_PATH" />		   
		 <result property="imageRename" column="IMG_RENAME" />		   
		 <result property="goodsPrice" column="GOODS_PRICE"/>
   </resultMap>
   
   
   
   

	<!-- 게시글 수 조회 -->
	<select id="getListCount">
		SELECT COUNT(*) FROM BOARD
		JOIN BOARD_TYPE USING(BOARD_CODE)
		WHERE BOARD_TYPE = #{boardType}
		AND DELETE_FL = 'N'
	</select>
	
	<!-- 굿즈 목록 조회 -->
	<select id="selectGoodsList">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, TO_CHAR(GOODS_PRICE, '999,999,999,999')||'원' GOODS_PRICE, GOODS_STOCK,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "GOODS" G ON(G.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'goods'
		ORDER BY GOODS_STOCK DESC
	</select>
	
	<!-- 낮은 가격순 조회 -->
	<select id="sortLowPrice">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, TO_CHAR(GOODS_PRICE, '999,999,999,999')||'원' GOODS_PRICE, GOODS_STOCK,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "GOODS" G ON(G.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'goods'
		ORDER BY GOODS_PRICE ASC
	</select>
	
	<!-- 높은 가격순 조회 -->
	<select id="sortHighPrice">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, TO_CHAR(GOODS_PRICE, '999,999,999,999')||'원' GOODS_PRICE, GOODS_STOCK,
		
		   <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]> 
		    
		    (SELECT COUNT(*) FROM "COMMENT" C
		    WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		    
		    (SELECT COUNT(*) FROM "LIKE" L
		    WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		    
		    (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		    WHERE I.BOARD_NO = B.BOARD_NO
		    AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "GOODS" G ON(G.BOARD_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = 'goods'
		ORDER BY GOODS_PRICE DESC
	</select>
	
	<!-- 이미지 조회 -->
	<select id="selectImageList" resultMap ="image_rm">
		SELECT * FROM IMAGE
		WHERE BOARD_NO = #{boardNo}
		ORDER BY IMG_ORDER	
	</select>
	
	
	<!-- 리뷰 목록 조회-->
	<select id="selectReviewList" resultMap="review_rm">	
		SELECT R1.*,  (SELECT ROUND((QUESTION1 + QUESTION2 + QUESTION3 + QUESTION4)/4,1)
            FROM REVIEW_QUESTION R2
            WHERE R2.REVIEW_NO = R1.REVIEW_NO) RATING
		FROM REVIEW R1
		WHERE BOARD_NO=#{boardNo}
		ORDER BY REVIEW_NO DESC		
	</select>
	
	
	
	
	
	
	<!-- 굿즈 상세 조회-->
	<select id="selectGoodsDetail" resultMap="goodsResultMap">
		SELECT BOARD_NO, BOARD_TITLE, BOARD_CONTENT, BOARD_CREATE_DATE,
        BOARD_UPDATE_DATE, BOARD_CODE, GOODS_PRICE, GOODS_STOCK
        ,(SELECT  NVL(ROUND(SUM(ROUND((QUESTION1 + QUESTION2 + QUESTION3 + QUESTION4)/4,1))/COUNT(*),1), 0) AS AVG_RATING
            FROM REVIEW_QUESTION
            WHERE REVIEW_NO IN (SELECT REVIEW_NO
                                FROM REVIEW
                                WHERE BOARD_NO = #{boardNo})) AVG_RATING,
        (SELECT COUNT(*) FROM REVIEW
        WHERE BOARD_NO = #{boardNo}) REVIEW_COUNT
		FROM BOARD
		JOIN GOODS USING(BOARD_NO)
		WHERE BOARD_NO = #{boardNo}
		
	</select>
	
	<!-- 리뷰 수 조회-->
	<select id="getReviewListCount" resultType="_int">
		
		SELECT COUNT(*)
		FROM REVIEW
		WHERE BOARD_NO = #{boardNo}
		
	</select>
	
	
	<select id="getQnaListCount" resultType="_int">
		SELECT COUNT(*)
		FROM "COMMENT"
		WHERE POST_NO = #{boardNo}
		
		
	</select>
	
	<!-- 댓글 목록 조회-->
	<select id="selectCommentList" resultMap="comment_rm">
		SELECT LEVEL, C.*
		FROM (SELECT COMMENT_NO, POST_NO, PARENT_COMMENT_NO, COMMENT_CONTENT,
		        COMMENT_CREATE_DATE, COMMENT_STATUS, MEMBER_NO, MEMBER_NICKNAME
		        FROM "COMMENT"
		        JOIN MEMBER USING(MEMBER_NO)
		        WHERE POST_NO = #{boardNo}) C
		START WITH PARENT_COMMENT_NO IS NULL
		CONNECT BY PRIOR COMMENT_NO = PARENT_COMMENT_NO
		ORDER SIBLINGS BY COMMENT_NO DESC	
	</select>


	<!-- 다른 굿즈 목록 조회-->
	<select id="selectOtherGoodsList" resultMap="othergoods_rm">
		SELECT * 
		FROM (SELECT BOARD_NO, BOARD_TITLE, IMG_PATH, IMG_RENAME, GOODS_PRICE 
		        FROM BOARD
		        JOIN GOODS USING(BOARD_NO)
		        JOIN IMAGE USING(BOARD_NO)
		        WHERE BOARD_NO != #{boardNo}
		        AND DELETE_FL = 'N'
		        AND IMG_ORDER = 0
		        AND GOODS_STOCK != 0
		        ORDER BY DBMS_RANDOM.VALUE)
		 <![CDATA[
		 	WHERE ROWNUM <= 20
		  ]]>
		
		
	</select>


	<!-- 굿즈 삭제 -->
	<update id="goodsDelete">
		UPDATE BOARD SET
		DELETE_FL = 'Y'
		WHERE BOARD_NO = #{boardNo}
	</update>
	
	
	<!-- 굿즈 삽입-->
	<insert id="goodsBoardInsert" useGeneratedKeys="true">
		
		<selectKey order="BEFORE" resultType="string" keyProperty="goodsNo">			
			SELECT 'G' || TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') || LPAD(SEQ_GOODS_NO.NEXTVAL, 5, '0') FROM DUAL		
		</selectKey>
		
		INSERT INTO BOARD VALUES(
		#{goodsNo},#{goodsTitle}, #{goodsContent}
		, SYSDATE, null, default
        ,(SELECT BOARD_CODE FROM BOARD_TYPE 
        	WHERE BOARD_TYPE = #{boardType})
    	,1, null, default)
		
		
		
	</insert>
	
	<!--굿즈 가격 수량 삽입-->
	<insert id="goodsInsert">
		INSERT INTO GOODS VALUES(
		#{goodsNo}, ${goodsPrice}, ${goodsStock}
		)
		
		
	</insert>
	
	<!-- 이미지 삽입-->
	<insert id="imageInsert">
		
		INSERT INTO IMAGE VALUES(
		SEQ_IMAGE_NO.NEXTVAL,
		#{imagePath},
		#{imageRename},
		#{imageOrder},
		#{boardNo})
				
	</insert>
	
	
	<!--굿즈 게시판 업데이트-->
	<update id="goodsBoardUpdate">
		UPDATE BOARD SET
		BOARD_TITLE =#{goodsTitle},
		BOARD_UPDATE_DATE = SYSDATE
		 <choose>
	        <when test="goodsContent != null and goodsContent != ''">
	            , BOARD_CONTENT = #{goodsContent}
	        </when>
	        <otherwise>
	            <!-- goodsContent가 null이거나 비어있으면 아무것도 하지 않음 -->
	        </otherwise>
    	</choose>
		WHERE BOARD_NO = #{goodsNo}
				
	</update>
	
	
	<!--굿즈 재고 수량-->
	<update id="goodsUpdate">
		UPDATE GOODS SET
		GOODS_PRICE=${goodsPrice},
		GOODS_STOCK=${goodsStock}
		WHERE BOARD_NO = #{goodsNo}
	</update>
	
	<!--굿즈 이미지 수정-->
	<update id="goodsImageUpdate">
		UPDATE IMAGE SET
		IMG_PATH = #{imagePath},
		IMG_RENAME=#{imageRename}
		WHERE BOARD_NO = #{boardNo}
	</update>
	
	
	
	
</mapper>