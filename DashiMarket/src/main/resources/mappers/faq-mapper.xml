<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.notice.model.dao.FaqMapper">

    <!-- FAQ 목록 조회 -->
    <select id="selectFaqList" resultType="edu.og.project.notice.model.dto.Faq">
        SELECT
            BOARD_NO AS faqNo,
            BOARD_TITLE AS faqTitle,
            BOARD_CONTENT AS faqContent,
            TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD') AS faqCreateDate,
            POST_VIEWS AS readCount
        FROM BOARD
        WHERE BOARD_CODE = 5
        AND DELETE_FL = 'N'
        <if test="query != null and query != ''">
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
        </if>
        ORDER BY BOARD_CREATE_DATE DESC, TO_NUMBER(BOARD_NO) DESC
        OFFSET #{offset} ROWS
        FETCH NEXT #{pageSize} ROWS ONLY
    </select>

    <!-- FAQ 전체 개수 조회 -->
    <select id="getFaqCount" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE BOARD_CODE = 5
        AND DELETE_FL = 'N'
        <if test="query != null and query != ''">
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
        </if>
    </select>

    <!-- FAQ 상세 조회 -->
    <select id="selectFaqDetail" parameterType="int" resultType="edu.og.project.notice.model.dto.Faq">
        SELECT
            BOARD_NO AS faqNo,
            BOARD_TITLE AS faqTitle,
            BOARD_CONTENT AS faqContent,
            TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD') AS faqCreateDate,
            BOARD_CODE,
            POST_VIEWS AS readCount
        FROM BOARD
        WHERE BOARD_NO = TO_CHAR(#{faqNo})
        AND BOARD_CODE = 5
        AND DELETE_FL = 'N'
    </select>

    <!-- FAQ 등록 -->
    <insert id="insertFaq" parameterType="edu.og.project.notice.model.dto.Faq">
        <selectKey keyProperty="faqNo" resultType="string" order="BEFORE">
            SELECT TO_CHAR(SEQ_NOTICE_NO.NEXTVAL) FROM DUAL
        </selectKey>
        
        INSERT INTO BOARD (
            BOARD_NO,
            BOARD_TITLE,
            BOARD_CONTENT,
            BOARD_CREATE_DATE,
            POST_VIEWS,
            BOARD_CODE,
            MEMBER_NO,
            DELETE_FL
        ) VALUES (
            #{faqNo},
            #{faqTitle},
            #{faqContent},
            SYSDATE,
            0,
            5,
            #{memberNo},
            'N'
        )
    </insert>

    <!-- FAQ 수정 -->
    <update id="updateFaq" parameterType="edu.og.project.notice.model.dto.Faq">
        UPDATE BOARD
        SET
            BOARD_TITLE = #{faqTitle},
            BOARD_CONTENT = #{faqContent}
        WHERE BOARD_NO = #{faqNo}
        AND BOARD_CODE = 5
        AND DELETE_FL = 'N'
    </update>

    <!-- FAQ 삭제 (논리 삭제) -->
    <update id="deleteFaq" parameterType="int">
        UPDATE BOARD
        SET DELETE_FL = 'Y'
        WHERE BOARD_NO = TO_CHAR(#{faqNo})
        AND BOARD_CODE = 5
    </update>

    <!-- 조회수 증가 -->
    <update id="increaseViewCount" parameterType="int">
        UPDATE BOARD
        SET POST_VIEWS = POST_VIEWS + 1
        WHERE BOARD_NO = TO_CHAR(#{faqNo})
        AND BOARD_CODE = 5
        AND DELETE_FL = 'N'
    </update>

</mapper>
