<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.notice.model.dao.FaqMapper">

    <!-- FAQ 목록 조회 -->
	<select id="selectFaqList" resultType="edu.og.project.notice.model.dto.Faq">
	    SELECT
	        BOARD_NO AS faqNo,
	        BOARD_TITLE AS faqTitle,
	        BOARD_CONTENT AS faqContent,
	        TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD') AS faqCreateDate,
	        POST_VIEWS AS readCount,
	        BOARD_CODE AS boardCode
	    FROM BOARD
	    WHERE BOARD_CODE = 5
	    AND DELETE_FL = 'N'
	    <if test="query != null and query != ''">
	        AND BOARD_TITLE LIKE '%' || #{query} || '%'
	    </if>
	    ORDER BY BOARD_CREATE_DATE DESC, TO_NUMBER(BOARD_NO) DESC
	    OFFSET #{offset} ROWS
	    FETCH NEXT #{pageSize} ROWS ONLY
	</select>




    <!-- FAQ 전체 개수 조회 -->
    <select id="getFaqCount" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE BOARD_CODE = 5
        AND DELETE_FL = 'N'
        <if test="query != null and query != ''">
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
        </if>
    </select>

    <!-- FAQ 상세 조회 (이미지 포함) -->
    <resultMap id="FaqResultMap" type="edu.og.project.notice.model.dto.Faq">
        <id property="faqNo" column="BOARD_NO"/>
        <result property="faqTitle" column="BOARD_TITLE"/>
        <result property="faqContent" column="BOARD_CONTENT"/>
        <result property="faqCreateDate" column="FAQ_CREATE_DATE"/>
        <result property="boardCode" column="BOARD_CODE"/>
        <result property="boardType" column="BOARD_TYPE"/>
        
        <collection property="imageList" ofType="edu.og.project.common.dto.Image">
            <id property="imageNo" column="IMG_NO"/>
            <result property="imagePath" column="IMG_PATH"/>
            <result property="imageRename" column="IMG_RENAME"/>
            <result property="imageOrder" column="IMG_ORDER"/>
            <result property="boardNo" column="BOARD_NO"/>
        </collection>
    </resultMap>
    
    <select id="selectFaqDetail" resultMap="FaqResultMap">
        SELECT
            B.BOARD_NO,
            B.BOARD_TITLE,
            B.BOARD_CONTENT,
            TO_CHAR(B.BOARD_CREATE_DATE, 'YYYY-MM-DD') AS FAQ_CREATE_DATE,
            B.BOARD_CODE,
            'faq' AS BOARD_TYPE,
            I.IMG_NO,
            I.IMG_PATH,
            I.IMG_RENAME,
            I.IMG_ORDER
        FROM BOARD B
        LEFT JOIN IMAGE I ON B.BOARD_NO = I.BOARD_NO
        WHERE B.BOARD_NO = #{faqNo}
        AND B.BOARD_CODE = 5
        AND B.DELETE_FL = 'N'
        ORDER BY I.IMG_ORDER ASC
    </select>

    <!-- FAQ 글 등록 -->
    <insert id="insertFaq" parameterType="edu.og.project.notice.model.dto.Faq">
        <selectKey keyProperty="faqNo" resultType="string" order="BEFORE">
            SELECT SEQ_NOTICE_NO.NEXTVAL FROM DUAL
        </selectKey>
        
        INSERT INTO BOARD (
            BOARD_NO,
            BOARD_TITLE,
            BOARD_CONTENT,
            BOARD_CREATE_DATE,
            POST_VIEWS,
            BOARD_CODE,
            MEMBER_NO,
            DELETE_FL
        ) VALUES (
            #{faqNo},
            #{faqTitle},
            #{faqContent},
            SYSDATE,
            0,
            5,
            1,
            'N'
        )
    </insert>
    
    <!-- 이미지 등록 -->
    <insert id="insertImage" parameterType="edu.og.project.common.dto.Image">
        INSERT INTO IMAGE (
            IMG_NO,
            IMG_PATH,
            IMG_RENAME,
            IMG_ORDER,
            BOARD_NO
        ) VALUES (
            SEQ_IMAGE_NO.NEXTVAL,
            #{imagePath},
            #{imageRename},
            #{imageOrder},
            #{boardNo}
        )
    </insert>

    <!-- FAQ 수정 -->
    <update id="updateFaq" parameterType="edu.og.project.notice.model.dto.Faq">
        UPDATE BOARD
        SET
            BOARD_TITLE = #{faqTitle},
            BOARD_CONTENT = #{faqContent},
            BOARD_CODE = 5
        WHERE BOARD_NO = #{faqNo}
        AND DELETE_FL = 'N'
    </update>
    
    <!-- 이미지 삭제 -->
    <delete id="deleteImagesByBoardNo">
        DELETE FROM IMAGE
        WHERE BOARD_NO = #{boardNo}
    </delete>

    <!-- FAQ 삭제 (논리 삭제) -->
    <update id="deleteFaq">
        UPDATE BOARD
        SET DELETE_FL = 'Y'
        WHERE BOARD_NO = #{faqNo}
        AND BOARD_CODE = 5
    </update>
    
    <!-- 조회수 증가 -->
	<update id="increaseViewCount">
	    UPDATE BOARD
	    SET POST_VIEWS = POST_VIEWS + 1
	    WHERE BOARD_NO = #{faqNo}
	    AND BOARD_CODE = 5
	    AND DELETE_FL = 'N'
	</update>
    

</mapper>
