<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.community.model.dao.CommunityMapper">

    <resultMap type="edu.og.project.community.model.dto.Community" id="communityResultMap">
    
        <id     property="boardNo"         column="BOARD_NO"/>
        
        <result property="boardTitle"      column="BOARD_TITLE"/>
        <result property="boardContent"    column="BOARD_CONTENT"/>
        <result property="boardCreateDate" column="BOARD_CREATE_DATE"/>
        <result property="boardUpdateDate" column="BOARD_UPDATE_DATE"/>
        <result property="postViews"       column="POST_VIEWS"/>
        <result property="boardCode"       column="BOARD_CODE"/>
		<result property="thumbnail" 	   column="THUMBNAIL"/>
		<result property="memberNickname"  column="MEMBER_NICKNAME"/>
        
        <result property="commentCount"    column="COMMENT_COUNT"/>
        <result property="likeCount"       column="LIKE_COUNT"/>
        
        <collection property="thumbnail" 
                    ofType="Image"
                    column="BOARD_NO" 
                    select="selectImageList" /> 
        
        <collection property="commentList" 
                    ofType="Comment"
                    column="BOARD_NO" 
                    select="selectCommentList" />
    </resultMap>
		   
	
		    
	<!-- 커뮤니티 목록 조회 -->
	<select id="selectCommunityList">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, CATEGORY_ID, DEFAULT_DONG,
		
		    <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]>
		    
		        (SELECT COUNT(*) FROM "COMMENT" C
		        WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		        
		        (SELECT COUNT(*) FROM "LIKE" L
		        WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		        
		        (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		        WHERE I.BOARD_NO = B.BOARD_NO
		        AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN "BOARD_TYPE" USING(BOARD_CODE)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = #{boardType}
		
		<!-- <if test="memberDong != null and memberDong != ''">
			AND DEFAULT_DONG = #{selectDong}
		</if> -->
		
		<!-- 카테고리가 null이면 전체 조회, 존재하면 해당 카테고리에 대한 게시판 조회 -->
		<if test="category != null and category != ''">
			CATEGORY_ID = #{category}
		</if>
		
		ORDER BY
		<choose>
			<!-- 인기순 -->
			<when test="sort == 'popular'">
				ORDER BY LIKE_COUNT DESC, B.POST_VIEWS DESC, B.BOARD_NO DESC
			</when>
			
			<!-- 최신순 -->
			<otherwise>
				B.BOARD_NO DESC
			</otherwise>
		</choose>
		
	</select>
	
</mapper>