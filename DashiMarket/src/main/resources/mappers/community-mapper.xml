<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.community.model.dao.CommunityMapper">

    <resultMap type="edu.og.project.community.model.dto.Community" id="community_rm">
    
        <id     property="boardNo"         column="BOARD_NO"/>
        
        <result property="categoryName"	   column="CATEGORY_NAME"/>
        <result property="boardTitle"      column="BOARD_TITLE"/>
        <result property="boardContent"    column="BOARD_CONTENT"/>
        <result property="boardCreateDate" column="BOARD_CREATE_DATE"/>
        <result property="boardUpdateDate" column="BOARD_UPDATE_DATE"/>
        <result property="postViews"       column="POST_VIEWS"/>
        <result property="boardCode"       column="BOARD_CODE"/>
		<result property="thumbnail" 	   column="THUMBNAIL"/>
		<result property="memberNickname"  column="MEMBER_NICKNAME"/>
		<result property="profilePath"  column="PROFILE_PATH"/>
		<result property="defaultDong"  column="DEFAULT_DONG"/>
        
        <result property="commentCount"    column="COMMENT_COUNT"/>
        <result property="likeCount"       column="LIKE_COUNT"/>
        
        <result property="childCommentCount"       column="CHILD_COMMENT_COUNT"/>
        
        <!-- 이미지 리스트 -->
        <collection property="imgList" 
                    ofType="Image"
                    column="BOARD_NO" 
                    select="selectImageList" /> 
        
        <!-- 댓글 리스트 -->
        <collection property="commentList" 
                    ofType="Comment"
                    column="BOARD_NO" 
                    select="selectCommentList" />
    </resultMap>
		  
   <!--이미지 rm-->
   <resultMap id="image_rm" type="Image">
	   
	  <id property="imageNo" column="IMG_NO"/>
      
      <result property="imagePath" column="IMG_PATH"/>
      <result property="imageRename" column="IMG_RENAME"/>
      <result property="imageOrder" column="IMG_ORDER"/>
      <result property="boardNo" column="BOARD_NO"/>   
   </resultMap>
   
   
   <resultMap id="comment_rm" type="edu.og.project.common.dto.Comment">
    
	    <id property="commentNo" column="COMMENT_NO" />
	    
	    <!-- 댓글 기본 정보 -->
	    <result property="postNo" column="POST_NO" />
	    <result property="parentCommentNo" column="PARENT_COMMENT_NO" />
	    <result property="commentContent" column="COMMENT_CONTENT" />
	    <result property="commentCreateDate" column="COMMENT_CREATE_DATE" />
	    <result property="commentUpdateDate" column="COMMENT_UPDATE_DATE" />
	    <result property="commentStatus" column="COMMENT_STATUS" />
	    <result property="childCommentCount" column="CHILD_COMMENT_COUNT" />
	    
	    <!-- 회원 정보 -->
	    <result property="memberNo" column="MEMBER_NO" />
	    <result property="memberNickname" column="MEMBER_NICKNAME" />
	    <result property="profileImage" column="PROFILE_PATH" />
	    
	    <!-- 계층 정보 -->
	    <result property="level" column="LEVEL" />
    
	</resultMap>
   
	
	<!-- 게시글 수 조회 -->
	<select id="getListCount" resultType="_int">
		SELECT COUNT(*) FROM BOARD
		JOIN BOARD_TYPE USING(BOARD_CODE)
		WHERE BOARD_TYPE = #{boardType}
		AND DELETE_FL = 'N'
		
		<if test="category != null and category != ''">
			AND CATEGORY_ID = #{category}
		</if>
	</select>
		    
	<!-- 커뮤니티 목록 조회 -->
	<select id="selectCommunityList" resultMap="community_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, CATEGORY_ID, DEFAULT_DONG,
		
		    <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]>
		    
		        (SELECT COUNT(*) FROM "COMMENT" C
		        WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		        
		        (SELECT COUNT(*) FROM "LIKE" L
		        WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		        
		        (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		        WHERE I.BOARD_NO = B.BOARD_NO
		        AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN "BOARD_TYPE" USING(BOARD_CODE)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = #{boardType}
		
		<!-- <if test="memberDong != null and memberDong != ''">
			AND DEFAULT_DONG = #{selectDong}
		</if> -->
		
		<!-- 카테고리가 null이면 전체 조회, 존재하면 해당 카테고리에 대한 게시판 조회 -->
		<if test="category != null and category != ''">
			AND CATEGORY_ID = #{category}
		</if>
		
		ORDER BY
		<choose>
			<!-- 인기순 -->
			<when test="sort == 'popular'">
				LIKE_COUNT DESC, B.POST_VIEWS DESC, B.BOARD_NO DESC
			</when>
			
			<!-- 최신순 -->
			<otherwise>
				B.BOARD_NO DESC
			</otherwise>
		</choose>
		
	</select>
	
	<!-- 커뮤니티 상세조회 -->
	<select id="communityDetail" resultMap="community_rm">
		SELECT CATEGORY_NAME, B.BOARD_NO, BOARD_TITLE, BOARD_CONTENT, MEMBER_NICKNAME, PROFILE_PATH, TO_CHAR(POST_VIEWS, 'FM999,999,999,999') POST_VIEWS, CATEGORY_ID, DEFAULT_DONG,
		
		    <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]>
		    
	    BOARD_UPDATE_DATE,
    
        (SELECT COUNT(*) FROM "COMMENT" C
        WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
        
        (SELECT COUNT(*) FROM "LIKE" L
        WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN "BOARD_TYPE" USING(BOARD_CODE)
		JOIN "CATEGORY" USING(CATEGORY_ID)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = #{boardType}
		AND BOARD_NO = #{boardNo}
	</select>
	
	<!-- 게시글 이미지 조회 -->
	<select id="selectImageList" resultMap="image_rm">
		SELECT * FROM IMAGE
		WHERE BOARD_NO = #{boardNo}
		ORDER BY IMG_ORDER	
	</select>
	
	<!-- 게시글 댓글 조회 -->
	<select id="selectCommentList" resultMap="comment_rm">
		SELECT LEVEL, C.*,
		
		      ( SELECT COUNT(*)
		        FROM "COMMENT" CHILD
		        WHERE CHILD.PARENT_COMMENT_NO = C.COMMENT_NO
		        AND CHILD.COMMENT_STATUS != 'DEL' ) CHILD_COMMENT_COUNT
		FROM (
		    SELECT 
		        COMMENT_NO, COMMENT_CONTENT, 
		        TO_CHAR(COMMENT_CREATE_DATE, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분" SS"초"') COMMENT_CREATE_DATE,
		        POST_NO, MEMBER_NO, MEMBER_NICKNAME, PROFILE_PATH, PARENT_COMMENT_NO, COMMENT_STATUS
		    FROM "COMMENT"
		    JOIN MEMBER USING(MEMBER_NO) ) C
		WHERE C.COMMENT_STATUS != 'DEL'
		AND POST_NO = #{boardNo}
		START WITH C.PARENT_COMMENT_NO IS NULL 
		CONNECT BY PRIOR C.COMMENT_NO = C.PARENT_COMMENT_NO
		
		ORDER SIBLINGS BY 
		
		<choose>
			<!-- 인기순 -->
			<when test="sort == 'popular'">
				CHILD_COMMENT_COUNT DESC
			</when>
			
			<!-- 최신순 -->
			<otherwise>
				C.COMMENT_NO DESC
			</otherwise>
		</choose>
		
	</select>
	
</mapper>