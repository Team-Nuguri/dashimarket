<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.og.project.community.model.dao.CommunityMapper">

    <resultMap type="edu.og.project.community.model.dto.Community" id="community_rm">
    
        <id     property="communityNo"         column="BOARD_NO"/>
        
        <result property="categoryId"	   column="CATEGORY_ID"/>
        <result property="categoryName"	   column="CATEGORY_NAME"/>
        <result property="communityTitle"      column="BOARD_TITLE"/>
        <result property="communityContent"    column="BOARD_CONTENT"/>
        <result property="communityCreateDate" column="BOARD_CREATE_DATE"/>
        <result property="communityUpdateDate" column="BOARD_UPDATE_DATE"/>
        <result property="postViews"       column="POST_VIEWS"/>
        <result property="boardCode"       column="BOARD_CODE"/>
        <result property="boardType"       column="BOARD_TYPE"/>
		<result property="thumbnail" 	   column="THUMBNAIL"/>
		<result property="memberNickname"  column="MEMBER_NICKNAME"/>
		<result property="memberNo"  	   column="MEMBER_NO"/>
		<result property="profilePath"     column="PROFILE_PATH"/>
		<result property="defaultDong"     column="DEFAULT_DONG"/>
        
        <result property="commentCount"    column="COMMENT_COUNT"/>
        <result property="likeCount"       column="LIKE_COUNT"/>
        <result property="likeCheck"       column="LIKE_CHECK"/>
        
        <result property="childCommentCount"       column="CHILD_COMMENT_COUNT"/>
        
        <!-- 이미지 리스트 -->
        <collection property="imgList" 
                    ofType="Image"
                    column="BOARD_NO" 
                    select="selectImageList" /> 
        
        <!-- 댓글 리스트 -->
        <collection property="commentList" 
                    ofType="Comment"
                    column="BOARD_NO" 
                    select="selectCommentList" />
    </resultMap>
		  
   <!--이미지 rm-->
   <resultMap id="image_rm" type="Image">
	   
	  <id property="imageNo" column="IMG_NO"/>
      
      <result property="imagePath" column="IMG_PATH"/>
      <result property="imageRename" column="IMG_RENAME"/>
      <result property="imageOrder" column="IMG_ORDER"/>
      <result property="boardNo" column="BOARD_NO"/>   
   </resultMap>
   
   
   <resultMap id="comment_rm" type="edu.og.project.common.dto.Comment">
    
	    <id property="commentNo" column="COMMENT_NO" />
	    
	    <!-- 댓글 기본 정보 -->
	    <result property="postNo" column="POST_NO" />
	    <result property="parentCommentNo" column="PARENT_COMMENT_NO" />
	    <result property="commentContent" column="COMMENT_CONTENT" />
	    <result property="commentCreateDate" column="COMMENT_CREATE_DATE" />
	    <result property="commentUpdateDate" column="COMMENT_UPDATE_DATE" />
	    <result property="commentStatus" column="COMMENT_STATUS" />
	    <result property="childCommentCount" column="CHILD_COMMENT_COUNT" />
	    
	    <!-- 회원 정보 -->
	    <result property="memberNo" column="MEMBER_NO" />
	    <result property="memberNickname" column="MEMBER_NICKNAME" />
	    <result property="profileImage" column="PROFILE_PATH" />
	    
	    <!-- 계층 정보 -->
	    <result property="level" column="LEVEL" />
    
	</resultMap>
   
	
	<!-- 게시글 수 조회 -->
	<select id="getListCount" resultType="_int">
		SELECT COUNT(*) FROM BOARD
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN MEMBER USING(MEMBER_NO)
		WHERE BOARD_TYPE = #{boardType}
		AND DELETE_FL = 'N'
		AND DEFAULT_DONG = '관철동'
		
		<if test="category != null and category != ''">
			AND CATEGORY_ID = #{category}
		</if>
	</select>
	
	<!-- 좋아요한 게시글 개수 -->
	<select id="getLikeListCount" resultType="_int">
		SELECT COUNT(*) FROM BOARD B
		JOIN BOARD_TYPE USING(BOARD_CODE)
		JOIN "LIKE" L ON (L.POST_NO = B.BOARD_NO)
		WHERE BOARD_TYPE = #{boardType}
		AND DELETE_FL = 'N'
		AND L.MEMBER_NO = ${memberNo}
	</select>
		    
	<!-- 커뮤니티 목록 조회 -->
	<select id="selectCommunityList" resultMap="community_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS, CATEGORY_ID, DEFAULT_DONG,
		
		    <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]>
		    
		        (SELECT COUNT(*) FROM "COMMENT" C
		        WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		        
		        (SELECT COUNT(*) FROM "LIKE" L
		        WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		        
		        <if test="memberNo != 0">
                (SELECT COUNT(*) FROM "LIKE" L2
		        WHERE L2.POST_NO = B.BOARD_NO
		        AND L2.MEMBER_NO = ${memberNo}) LIKE_CHECK,
		        </if>
		        
		        (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		        WHERE I.BOARD_NO = B.BOARD_NO
		        AND IMG_ORDER = 0) THUMBNAIL
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN "BOARD_TYPE" USING(BOARD_CODE)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = #{boardType}
		
		
		<if test="finalDong != null and finalDong != ''">
			AND DEFAULT_DONG = #{finalDong}
		</if>
		
		<!-- 카테고리가 null이면 전체 조회, 존재하면 해당 카테고리에 대한 게시판 조회 -->
		<if test="category != null and category != ''">
			AND CATEGORY_ID = #{category}
		</if>
		
		ORDER BY
		<choose>
			<!-- 인기순 -->
			<when test="sort == 'popular'">
				LIKE_COUNT DESC, B.POST_VIEWS DESC, B.BOARD_NO DESC
			</when>
			
			<!-- 최신순 -->
			<otherwise>
				B.BOARD_NO DESC
			</otherwise>
		</choose>
		
	</select>
	
	<!-- 좋아요한 게시글 조회 -->
	<select id="selectLikeCommunityList" resultMap="community_rm">
		SELECT B.BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME, POST_VIEWS,
		    
		    <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]>
		    
		        (SELECT COUNT(*) FROM "COMMENT" C
		        WHERE C.POST_NO = B.BOARD_NO) COMMENT_COUNT,
		        
		        (SELECT COUNT(*) FROM "LIKE" L
		        WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT,
		        
		        (SELECT IMG_PATH || IMG_RENAME FROM IMAGE I
		        WHERE I.BOARD_NO = B.BOARD_NO
		        AND IMG_ORDER = 0) THUMBNAIL,
		        
		        BOARD_TYPE
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN "BOARD_TYPE" USING(BOARD_CODE)
		JOIN "LIKE" L ON(L.POST_NO = B.BOARD_NO)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = #{boardType}
		AND L.MEMBER_NO = ${memberNo}
		ORDER BY BOARD_NO DESC
	</select>
	
	<!-- 커뮤니티 상세조회 -->
	<select id="communityDetail" resultMap="community_rm">
		SELECT CATEGORY_NAME, B.BOARD_NO, BOARD_TITLE, BOARD_CONTENT, MEMBER_NO, MEMBER_NICKNAME, PROFILE_PATH, TO_CHAR(POST_VIEWS, 'FM999,999,999,999') POST_VIEWS, CATEGORY_ID, DEFAULT_DONG,
		
		    <![CDATA[     
		    CASE  
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24/60
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1/24
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24 * 60) || '분 전'
		       WHEN SYSDATE - BOARD_CREATE_DATE < 1
		       THEN FLOOR( (SYSDATE - BOARD_CREATE_DATE) * 24) || '시간 전'
		       ELSE TO_CHAR(BOARD_CREATE_DATE, 'YYYY-MM-DD')
		    END BOARD_CREATE_DATE,
		    ]]>
		    
	    BOARD_UPDATE_DATE,
    
        (SELECT COUNT(*) FROM "COMMENT" C
        WHERE C.POST_NO = B.BOARD_NO
        AND C.COMMENT_STATUS != 'DEL') COMMENT_COUNT,
        
        (SELECT COUNT(*) FROM "LIKE" L
        WHERE L.POST_NO = B.BOARD_NO) LIKE_COUNT
		    
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		JOIN "BOARD_TYPE" USING(BOARD_CODE)
		JOIN "CATEGORY" USING(CATEGORY_ID)
		WHERE DELETE_FL = 'N'
		AND BOARD_TYPE = #{boardType}
		AND BOARD_NO = #{boardNo}
	</select>
	
	<!-- 게시글 이미지 조회 -->
	<select id="selectImageList" resultMap="image_rm">
		SELECT * FROM IMAGE
		WHERE BOARD_NO = #{communityNo}
		ORDER BY IMG_ORDER	
	</select>
	
	<!-- 게시글 댓글 조회 -->
	<select id="selectCommentList" resultMap="comment_rm">
		SELECT LEVEL, C.*,
		
		      ( SELECT COUNT(*)
		        FROM "COMMENT" CHILD
		        WHERE CHILD.PARENT_COMMENT_NO = C.COMMENT_NO
		        AND CHILD.COMMENT_STATUS != 'DEL' ) CHILD_COMMENT_COUNT
		FROM (
		    SELECT 
		        COMMENT_NO, COMMENT_CONTENT, 
		        TO_CHAR(COMMENT_CREATE_DATE, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분"') COMMENT_CREATE_DATE,
		        TO_CHAR(COMMENT_UPDATE_DATE, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분"') COMMENT_UPDATE_DATE,
		        POST_NO, MEMBER_NO, MEMBER_NICKNAME, PROFILE_PATH, PARENT_COMMENT_NO, COMMENT_STATUS
		    FROM "COMMENT"
		    JOIN MEMBER USING(MEMBER_NO) ) C
		WHERE POST_NO = #{boardNo}
		START WITH C.PARENT_COMMENT_NO IS NULL 
		CONNECT BY PRIOR C.COMMENT_NO = C.PARENT_COMMENT_NO
		
		ORDER SIBLINGS BY 
		
		<choose>
			<!-- 인기순 -->
			<when test="sort == 'popular'">
				CHILD_COMMENT_COUNT DESC
			</when>
			
			<!-- 최신순 -->
			<otherwise>
				C.COMMENT_NO DESC
			</otherwise>
		</choose>
		
	</select>
	
	
	<!-- 댓글 등록 -->
	<insert id="insertComment" useGeneratedKeys="true">
		<selectKey order="BEFORE" resultType="_int" keyProperty="commentNo">
			SELECT SEQ_COMMENT_NO.NEXTVAL FROM DUAL
		</selectKey>
	
		INSERT INTO "COMMENT" VALUES
		(${commentNo}, #{postNo}, 
		
		<!-- 부모댓글 여부에 따라 댓글과 답글 나누기 -->
		<if test="parentCommentNo == 0">
			NULL, 
		</if>
		
		<if test="parentCommentNo != 0">
			${parentCommentNo}, 
		</if>
		
		
		${memberNo}, #{commentContent}, DEFAULT, NULL, DEFAULT, DEFAULT)
	</insert>
	
	
	<!-- 커뮤니티 글쓰기 -->
	<insert id="communityWrite">
		<selectKey order="BEFORE" resultType="string" keyProperty="communityNo">
			SELECT 'C' || TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') || LPAD(SEQ_COMMUNITY_NO.NEXTVAL, 5, '0') FROM DUAL
		</selectKey>
		
		INSERT INTO BOARD VALUES
			(#{communityNo}, #{communityTitle}, #{communityContent},
			DEFAULT, NULL, DEFAULT, 
			(SELECT BOARD_CODE FROM BOARD_TYPE WHERE BOARD_TYPE=#{boardType}), 
			${memberNo}, #{categoryId}, DEFAULT)
	</insert>
	
	<!-- 이미지 업로드 -->
	<insert id="insertImageList">
		INSERT INTO IMAGE
		SELECT SEQ_IMAGE_NO.NEXTVAL, A.*
		
		FROM (
			<foreach collection="list" item="img" separator="UNION ALL">
				
				SELECT #{img.imagePath} IMG_PATH
						, #{img.imageRename} IMG_RENAME
						, ${img.imageOrder} IMG_ORDER
						, #{img.boardNo} BOARD_NO
				FROM DUAL		
			</foreach>
			) A	
	</insert>
	
	<!-- 댓글 수정 -->
	<update id="updateComment">
		UPDATE "COMMENT" SET
		COMMENT_CONTENT = #{commentContent},
		COMMENT_UPDATE_DATE = SYSDATE
		WHERE COMMENT_NO = ${commentNo}
	</update>
	
	<!-- 댓글 삭제 -->
	<update id="deleteComment">
		UPDATE "COMMENT" SET
		COMMENT_STATUS = 'DEL'
		WHERE COMMENT_NO = ${commentNo}
	</update>
	
	<!-- 게시글 수정 -->
	<update id="communityUpdate">
		UPDATE BOARD SET
		BOARD_TITLE = #{communityTitle},
		BOARD_CONTENT = #{communityContent},
		BOARD_UPDATE_DATE = SYSDATE,
		CATEGORY_ID = #{categoryId}
		WHERE BOARD_NO = #{communityNo}
	</update>
	
	<!-- 이미지 삭제 -->
	<delete id="imageDelete">
		DELETE FROM IMAGE
		WHERE BOARD_NO = #{communityNo}
		AND IMG_ORDER IN (${deleteList})
	</delete>
	
	<!-- 이미지 삭제 후 이미지 순서 재정렬 -->
	<update id="sortImageOrder">
		UPDATE IMAGE SET
		IMG_ORDER =  ROWNUM - 1
		WHERE BOARD_NO = #{communityNo}
	</update>
	
	<!-- 이미지 시작 인덱스 조회 -->
	<select id="selectImageOrder">
		SELECT NVL(MAX(IMG_ORDER), -1) FROM IMAGE
		WHERE BOARD_NO = #{communityNo}
	</select>
	
	<!-- 게시글 삭제 -->
	<update id="communityDelete">
		UPDATE BOARD SET
		DELETE_FL = 'Y'
		WHERE BOARD_NO = #{communityNo}
	</update>
	
	<!-- 좋아요 여부 확인 -->
	<select id="communityLikeCheck">
		SELECT COUNT(*)
		FROM "LIKE"
		WHERE POST_NO = #{boardNo}
		AND MEMBER_NO = ${memberNo}
	</select>
	
	<!-- 좋아요 삽입 -->
	<insert id="insertCommunityLike">
		INSERT INTO "LIKE"
		VALUES(#{communityNo}, ${memberNo})
	</insert>
	
	<!-- 좋아요 삭제 -->
	<delete id="deleteCommunityLike">
		DELETE FROM "LIKE"
		WHERE POST_NO = #{communityNo}
		AND MEMBER_NO = ${memberNo}
	</delete>
	
	<!-- 좋아요 개수 -->
	<select id="countCommunityLike" resultType="_int">
		SELECT COUNT(*) FROM "LIKE"
		WHERE POST_NO = #{communityNo}
	</select>
	
	<!-- 조회수 증가 -->
	<update id="updateReadCount">
		UPDATE BOARD SET
		POST_VIEWS = POST_VIEWS + 1
		WHERE BOARD_NO = #{boardNo}
	</update>
	
</mapper>